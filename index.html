<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login Sistema Gestión Documentos - Login</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
  body { font-family: Arial; margin: 0; background: #f4f4f4; }
  .login, .dashboard { max-width: 600px; margin: 50px auto; background: #fff; padding:20px; border-radius:5px; }
  h1,h2 { text-align:center; color:#333; }
  input, button, select, textarea { width: 100%; padding:8px; margin:5px 0; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding:6px; text-align:left; }
  th { background:#eee; }
  .hidden { display:none; }
</style>
</head>
<body>

<div class="login" id="loginScreen">
  <h1>Login</h1>
  <input type="text" id="login_usuario" placeholder="Usuario">
  <input type="password" id="login_contrasena" placeholder="Contraseña">
  <button onclick="login()">Ingresar</button>
  <p id="login_error" style="color:red;"></p>
</div>

<div class="dashboard hidden" id="dashboardScreen">
  <h1>Bienvenido, <span id="usuarioActual"></span></h1>
  <button onclick="logout()">Cerrar Sesión</button>

  <div class="section">
    <h2>Usuarios</h2>
    <input type="text" id="usuario_nombre" placeholder="Nombre de usuario">
    <input type="password" id="usuario_contrasena" placeholder="Contraseña">
    <input type="text" id="usuario_correo" placeholder="Correo para notificaciones">
    <select id="usuario_rol">
      <option value="admin">Admin</option>
      <option value="gerente">Gerente</option>
      <option value="normal">Usuario</option>
    </select>
    <button onclick="crearUsuario()">Agregar Usuario</button>
    <table id="tablaUsuarios">
      <thead><tr><th>Nombre</th><th>Correo</th><th>Rol</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Crear Solicitud</h2>
    <select id="solicitante_usuario"></select>
    <select id="solicitud_tipo_documento">
      <option value="Procedimiento">Procedimiento</option>
      <option value="Guía">Guía</option>
      <option value="Instructivo">Instructivo</option>
      <option value="Manual">Manual</option>
      <option value="Formato">Formato</option>
    </select>
    <select id="solicitud_accion">
      <option value="Creación">Creación</option>
      <option value="Modificación">Modificación</option>
      <option value="Inactivación">Inactivación</option>
    </select>
    <input type="text" id="solicitud_nombre" placeholder="Nombre del Documento">
    <input type="text" id="solicitud_fecha_version" placeholder="Fecha Última Versión (solo modificar/inactivar)">
    <input type="text" id="solicitud_version" placeholder="Última Versión (solo modificar/inactivar)">
    <input type="text" id="solicitud_codificacion" placeholder="Codificación (solo modificar/inactivar)">
    <select id="solicitud_gerencia"></select>
    <select id="solicitud_departamento"></select>
    <textarea id="solicitud_motivo" placeholder="Motivo"></textarea>
    <input type="file" id="solicitud_archivo">
    <button onclick="crearSolicitud()">Crear Solicitud</button>

    <table id="tablaSolicitudes">
      <thead><tr>
        <th>ID</th><th>Usuario</th><th>Documento</th><th>Acción</th><th>Gerencia</th>
        <th>Departamento</th><th>Motivo</th><th>Estado</th><th>Archivo</th><th>Acciones</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
    authDomain: "sistemadegestion-7400d.firebaseapp.com",
    projectId: "sistemadegestion-7400d",
    storageBucket: "sistemadegestion-7400d.appspot.com",
    messagingSenderId: "709030283072",
    appId: "1:709030283072:web:5997837b36a448e9515ca5"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Cloudinary
  const cloudName = 'df79cjklp';
  const uploadPreset = 'fci_documentos';

  let usuarioActivo=null;

  // ===== Login =====
  async function login(){
    const usuario=document.getElementById('login_usuario').value;
    const contrasena=document.getElementById('login_contrasena').value;
    const errorP=document.getElementById('login_error');
    errorP.textContent='';

    if(usuario==='Admin' && contrasena==='1130'){ // login admin
      usuarioActivo={nombre:'Admin', rol:'admin'};
      mostrarDashboard();
      return;
    }

    const snapshot=await db.collection('usuarios').where('nombre','==',usuario).where('contrasena','==',contrasena).get();
    if(snapshot.empty){ errorP.textContent='Usuario o contraseña incorrectos'; return; }
    usuarioActivo={nombre:usuario, ...snapshot.docs[0].data()};
    mostrarDashboard();
  }

  function logout(){
    usuarioActivo=null;
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('dashboardScreen').classList.add('hidden');
  }

  function mostrarDashboard(){
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('dashboardScreen').classList.remove('hidden');
    document.getElementById('usuarioActual').textContent=usuarioActivo.nombre;
    cargarUsuarios(); cargarGerencias(); cargarDepartamentos(); cargarSolicitudes();
  }

  // ===== Usuarios =====
  async function crearUsuario(){
    const nombre=document.getElementById('usuario_nombre').value;
    const contrasena=document.getElementById('usuario_contrasena').value;
    const correo=document.getElementById('usuario_correo').value;
    const rol=document.getElementById('usuario_rol').value;
    if(!nombre || !contrasena || !correo){ alert('Completa todos los campos'); return; }
    await db.collection('usuarios').add({nombre, contrasena, correo, rol});
    cargarUsuarios();
    document.getElementById('usuario_nombre').value='';
    document.getElementById('usuario_contrasena').value='';
    document.getElementById('usuario_correo').value='';
  }

  async function cargarUsuarios(){
    const tbody = document.querySelector('#tablaUsuarios tbody'); tbody.innerHTML='';
    const select = document.getElementById('solicitante_usuario'); select.innerHTML='<option value="">Seleccione Usuario</option>';
    const snapshot = await db.collection('usuarios').get();
    snapshot.forEach(doc=>{
      const data = doc.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${data.nombre}</td><td>${data.correo}</td><td>${data.rol}</td>
        <td><button onclick="eliminarUsuario('${doc.id}')">Eliminar</button></td>`;
      tbody.appendChild(tr);
      const option = document.createElement('option'); option.value=data.nombre; option.textContent=data.nombre; select.appendChild(option);
    });
  }
  async function eliminarUsuario(id){ await db.collection('usuarios').doc(id).delete(); cargarUsuarios(); }

  // ===== Solicitudes =====
  async function crearSolicitud(){
    if(!usuarioActivo){ alert('No hay usuario activo'); return; }
    const usuario = usuarioActivo.nombre;
    const tipo_documento = document.getElementById('solicitud_tipo_documento').value;
    const accion = document.getElementById('solicitud_accion').value;
    const nombre = document.getElementById('solicitud_nombre').value;
    const fecha_version = document.getElementById('solicitud_fecha_version').value;
    const version = document.getElementById('solicitud_version').value;
    const codificacion = document.getElementById('solicitud_codificacion').value;
    const gerencia = document.getElementById('solicitud_gerencia').value;
    const departamento = document.getElementById('solicitud_departamento').value;
    const motivo = document.getElementById('solicitud_motivo').value;
    const archivoInput = document.getElementById('solicitud_archivo');
    let archivoURL='';

    if(archivoInput.files.length>0){
      const file = archivoInput.files[0];
      const formData = new FormData();
      formData.append('file',file); formData.append('upload_preset', uploadPreset);
      const res = await axios.post(`https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`, formData);
      archivoURL=res.data.secure_url;
    }

    const counterRef=db.collection('counters').doc('solicitudes');
    const counterDoc=await counterRef.get();
    let counter=1; if(counterDoc.exists){ counter=counterDoc.data().count+1; }
    await counterRef.set({count:counter});
    const idSolicitud='FCI-SOL-'+counter.toString().padStart(4,'0');

    await db.collection('solicitudes').add({
      id:idSolicitud, usuario, tipo_documento, accion, nombre, fecha_version, version, codificacion,
      gerencia, departamento, motivo, archivo:archivoURL, estado:'Pendiente', observacion:''
    });

    cargarSolicitudes();
    document.getElementById('solicitud_nombre').value='';
    document.getElementById('solicitud_fecha_version').value='';
    document.getElementById('solicitud_version').value='';
    document.getElementById('solicitud_codificacion').value='';
    document.getElementById('solicitud_motivo').value='';
    archivoInput.value='';
  }

  async function cargarSolicitudes(){
    const tbody = document.querySelector('#tablaSolicitudes tbody'); tbody.innerHTML='';
    const snapshot = await db.collection('solicitudes').get();
    snapshot.forEach(doc=>{
      const data=doc.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${data.id}</td>
        <td>${data.usuario}</td>
        <td>${data.nombre}</td>
        <td>${data.accion}</td>
        <td>${data.gerencia}</td>
        <td>${data.departamento}</td>
        <td>${data.motivo}</td>
        <td>${data.estado}</td>
        <td>${data.archivo?`<a href="${data.archivo}" target="_blank">Ver</a>`:''}</td>
        <td><button onclick="eliminarSolicitud('${doc.id}')">Eliminar</button></td>`;
      tbody.appendChild(tr);
    });
  }
  async function eliminarSolicitud(id){ await db.collection('solicitudes').doc(id).delete(); cargarSolicitudes(); }

  // ===== Inicial =====
  cargarUsuarios(); cargarSolicitudes();
</script>
</body>
</html>