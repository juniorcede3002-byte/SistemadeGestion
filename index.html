<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Gestión</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
h2,h3{ margin-top:0; }
input, select, button { margin:5px 0; padding:5px; }
button { cursor:pointer; }
.tab { display:none; background:#fff; padding:15px; border-radius:8px; margin-top:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.container { max-width:1200px; margin:auto; }
table { border-collapse: collapse; width:100%; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:left; }
.modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.5);}
.modal-content { background:#fff; margin:10% auto; padding:20px; width:80%; border-radius:8px; }
.close { float:right; cursor:pointer; color:red; font-weight:bold; }
</style>
</head>
<body>

<h1>Sistema de Gestión</h1>

<!-- LOGIN -->
<div id="login-div">
<h3>Login</h3>
<input type="text" id="loginUser" placeholder="Usuario"><br>
<input type="password" id="loginPass" placeholder="Contraseña"><br>
<button onclick="login()">Ingresar</button>
<p id="loginMsg" style="color:red;"></p>
</div>

<!-- DASHBOARD -->
<section id="dashboard" style="display:none;">
<h2>Panel Administrativo</h2>
<div class="container">

<!-- Tabs -->
<div style="display:flex; gap:10px; margin-bottom:10px;">
<button onclick="abrirTab('usuarios-tab')">Usuarios</button>
<button onclick="abrirTab('gerencias-tab')">Gerencias</button>
<button onclick="abrirTab('departamentos-tab')">Departamentos</button>
<button onclick="abrirTab('solicitudes-tab')">Solicitudes</button>
<button onclick="abrirTab('nueva-solicitud-tab')">Nueva Solicitud</button>
</div>

<!-- TAB USUARIOS -->
<div id="usuarios-tab" class="tab">
<h3>Usuarios</h3>
<input type="text" id="userNombre" placeholder="Nombre">
<input type="text" id="userPass" placeholder="Contraseña">
<input type="email" id="userCorreo" placeholder="Correo">
<select id="userRol">
<option value="Usuario">Usuario</option>
<option value="Gerente">Gerente</option>
<option value="Admin">Admin</option>
</select>
<br>
<label><input type="checkbox" id="permSolicitudes"> Realizar Solicitudes</label>
<label><input type="checkbox" id="permVerPropias"> Ver Solicitudes Propias</label>
<label><input type="checkbox" id="permVerGerencia"> Ver Solicitudes Gerencia</label>
<label><input type="checkbox" id="permAprobar"> Aprobar/Rechazar Solicitudes</label>
<label><input type="checkbox" id="permGestionUsuarios"> Gestionar Usuarios</label>
<br>
<button onclick="crearUsuario()">Crear Usuario</button>
<table id="tablaUsuarios"><thead><tr><th>Nombre</th><th>Rol</th><th>Opciones</th></tr></thead><tbody></tbody></table>
</div>

<!-- TAB GERENCIAS -->
<div id="gerencias-tab" class="tab">
<h3>Gerencias</h3>
<input type="text" id="gerenciaNombre" placeholder="Nombre Gerencia">
<button onclick="crearGerencia()">Agregar Gerencia</button>
<table id="tablaGerencias"><thead><tr><th>Nombre</th><th>Opciones</th></tr></thead><tbody></tbody></table>
</div>

<!-- TAB DEPARTAMENTOS -->
<div id="departamentos-tab" class="tab">
<h3>Departamentos</h3>
<input type="text" id="departamentoNombre" placeholder="Nombre Departamento">
<select id="depGerenciaSelect"></select>
<button onclick="crearDepartamento()">Agregar Departamento</button>
<table id="tablaDepartamentos"><thead><tr><th>Nombre</th><th>Gerencia</th><th>Opciones</th></tr></thead><tbody></tbody></table>
</div>

<!-- TAB SOLICITUDES -->
<div id="solicitudes-tab" class="tab">
<h3>Solicitudes</h3>
<table id="tablaSolicitudes">
<thead>
<tr>
<th>Documento</th><th>Tipo</th><th>Acción</th><th>Gerencia</th><th>Departamento</th><th>Estado</th><th>Solicitante</th><th>Opciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- TAB NUEVA SOLICITUD -->
<div id="nueva-solicitud-tab" class="tab">
<h3>Crear Nueva Solicitud</h3>
<input type="text" id="solNombre" placeholder="Nombre del documento"><br>
<select id="solTipo">
<option value="Procedimiento">Procedimiento</option>
<option value="Guía">Guía</option>
<option value="Instructivo">Instructivo</option>
<option value="Manual">Manual</option>
<option value="Formato">Formato</option>
</select>
<select id="solAccion">
<option value="Creación">Creación</option>
<option value="Modificación">Modificación</option>
<option value="Inactivación">Inactivación</option>
</select><br>
<select id="solGerencia"></select>
<select id="solDepartamento"></select><br>
<input type="text" id="solMotivo" placeholder="Motivo"><br>
<input type="text" id="solUltimaVersion" placeholder="Última versión (solo Mod/Inact)"><br>
<input type="text" id="solFechaUltima" placeholder="Fecha última versión"><br>
<input type="text" id="solCodigo" placeholder="Codificación"><br>
<button onclick="crearSolicitud()">Crear Solicitud</button>
</div>

</section>

<!-- MODAL DETALLES -->
<div id="modalDetalle" class="modal">
<div class="modal-content">
<span class="close" onclick="cerrarModal()">&times;</span>
<div id="detalleContenido"></div>
</div>
</div>

<script>
// FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// LOGIN
let currentUser = null;
const usuariosSistema = [{usuario:"Admin",pass:"1130",rol:"Admin"}];

function login(){
  const u = document.getElementById("loginUser").value;
  const p = document.getElementById("loginPass").value;
  const found = usuariosSistema.find(x=>x.usuario===u && x.pass===p);
  if(found){
    currentUser = found;
    document.getElementById("login-div").style.display="none";
    document.getElementById("dashboard").style.display="block";
    cargarUsuarios();
    cargarGerencias();
    cargarDepartamentos();
    cargarSolicitudes();
    cargarGerenciasSolicitudes();
    cargarDepartamentosSolicitudes();
  } else {
    document.getElementById("loginMsg").innerText="Usuario o contraseña incorrectos";
  }
}

// TABS
function abrirTab(tabId){
  document.querySelectorAll(".tab").forEach(t=>t.style.display="none");
  document.getElementById(tabId).style.display="block";
}

// USUARIOS
async function crearUsuario(){
  const nombre = document.getElementById("userNombre").value;
  const pass = document.getElementById("userPass").value;
  const correo = document.getElementById("userCorreo").value;
  const rol = document.getElementById("userRol").value;
  const permisos = {
    solicitudes: document.getElementById("permSolicitudes").checked,
    verPropias: document.getElementById("permVerPropias").checked,
    verGerencia: document.getElementById("permVerGerencia").checked,
    aprobar: document.getElementById("permAprobar").checked,
    gestionar: document.getElementById("permGestionUsuarios").checked
  };
  await db.collection("usuarios").add({nombre, pass, correo, rol, permisos});
  cargarUsuarios();
}
async function cargarUsuarios(){
  const tbody = document.querySelector("#tablaUsuarios tbody");
  tbody.innerHTML="";
  const snapshot = await db.collection("usuarios").get();
  snapshot.forEach(doc=>{
    const d = doc.data();
    tbody.innerHTML += `<tr>
      <td>${d.nombre}</td><td>${d.rol}</td>
      <td>
        <button onclick="editarUsuario('${doc.id}')">Editar</button>
        <button onclick="eliminarUsuario('${doc.id}')">Eliminar</button>
      </td>
    </tr>`;
  });
}
async function eliminarUsuario(id){ await db.collection("usuarios").doc(id).delete(); cargarUsuarios(); }
function editarUsuario(id){ alert("Función editar usuario pendiente"); }

// GERENCIAS
async function crearGerencia(){
  const nombre = document.getElementById("gerenciaNombre").value;
  await db.collection("gerencias").add({nombre});
  cargarGerencias();
  cargarGerenciasSolicitudes();
}
async function cargarGerencias(){
  const tbody = document.querySelector("#tablaGerencias tbody");
  tbody.innerHTML="";
  const snapshot = await db.collection("gerencias").get();
  snapshot.forEach(doc=>{
    const d = doc.data();
    tbody.innerHTML += `<tr><td>${d.nombre}</td><td><button onclick="eliminarGerencia('${doc.id}')">Eliminar</button></td></tr>`;
  });
}
async function eliminarGerencia(id){ await db.collection("gerencias").doc(id).delete(); cargarGerencias(); cargarGerenciasSolicitudes(); }

// DEPARTAMENTOS
async function crearDepartamento(){
  const nombre = document.getElementById("departamentoNombre").value;
  const gerencia = document.getElementById("depGerenciaSelect").value;
  await db.collection("departamentos").add({nombre, gerencia});
  cargarDepartamentos();
  cargarDepartamentosSolicitudes();
}
async function cargarDepartamentos(){
  const tbody = document.querySelector("#tablaDepartamentos tbody");
  tbody.innerHTML="";
  const snapshot = await db.collection("departamentos").get();
  snapshot.forEach(doc=>{
    const d = doc.data();
    tbody.innerHTML += `<tr><td>${d.nombre}</td><td>${d.gerencia}</td><td><button onclick="eliminarDepartamento('${doc.id}')">Eliminar</button></td></tr>`;
  });
}
async function eliminarDepartamento(id){ await db.collection("departamentos").doc(id).delete(); cargarDepartamentos(); cargarDepartamentosSolicitudes(); }

// SOLICITUDES
async function cargarSolicitudes(){
  const tbody = document.querySelector("#tablaSolicitudes tbody");
  tbody.innerHTML="";
  const snapshot = await db.collection("solicitudes").get();
  snapshot.forEach(doc=>{
    const d = doc.data();
    tbody.innerHTML += `<tr>
      <td>${d.nombreDocumento}</td>
      <td>${d.tipo}</td>
      <td>${d.accion}</td>
      <td>${d.gerencia}</td>
      <td>${d.departamento}</td>
      <td>${d.estado}</td>
      <td>${d.usuario}</td>
      <td>
        <button onclick="verDetalle('${doc.id}')">Ver</button>
      </td>
    </tr>`;
  });
}

// CREAR SOLICITUD
async function crearSolicitud(){
  const solicitud = {
    nombreDocumento: document.getElementById("solNombre").value,
    tipo: document.getElementById("solTipo").value,
    accion: document.getElementById("solAccion").value,
    gerencia: document.getElementById("solGerencia").value,
    departamento: document.getElementById("solDepartamento").value,
    motivo: document.getElementById("solMotivo").value,
    ultimaVersion: document.getElementById("solUltimaVersion").value,
    fechaUltima: document.getElementById("solFechaUltima").value,
    codificacion: document.getElementById("solCodigo").value,
    estado: "Pendiente",
    usuario: currentUser.usuario
  };
  await db.collection("solicitudes").add(solicitud);
  alert("Solicitud creada");
  cargarSolicitudes();
}

// DETALLES Y CAMBIO DE ESTADO
async function verDetalle(id){
  const doc = await db.collection("solicitudes").doc(id).get();
  const d = doc.data();
  let html = `<h3>Detalles de Solicitud</h3>
    <p><b>Documento:</b> ${d.nombreDocumento}</p>
    <p><b>Tipo:</b> ${d.tipo}</p>
    <p><b>Acción:</b> ${d.accion}</p>
    <p><b>Gerencia:</b> ${d.gerencia}</p>
    <p><b>Departamento:</b> ${d.departamento}</p>
    <p><b>Motivo:</b> ${d.motivo}</p>
    <p><b>Última Versión:</b> ${d.ultimaVersion}</p>
    <p><b>Fecha Última:</b> ${d.fechaUltima}</p>
    <p><b>Codificación:</b> ${d.codificacion}</p>
    <p><b>Estado:</b> ${d.estado}</p>
    <p><b>Solicitante:</b> ${d.usuario}</p>`;

  if(currentUser.rol==="Admin" || currentUser.rol==="Gerente"){
    html += `<br><label>Cambiar Estado:
      <select id="nuevoEstado">
        <option value="Pendiente">Pendiente</option>
        <option value="Aprobado">Aprobado</option>
        <option value="Rechazado">Rechazado</option>
      </select></label>
      <br><label>Motivo de rechazo (si aplica): <input type="text" id="motivoRechazo"></label>
      <br><button onclick="cambiarEstado('${id}')">Guardar</button>`;
  }

  document.getElementById("detalleContenido").innerHTML=html;
  document.getElementById("modalDetalle").style.display="block";
}

async function cambiarEstado(id){
  const estado = document.getElementById("nuevoEstado").value;
  const motivo = document.getElementById("motivoRechazo").value;
  await db.collection("solicitudes").doc(id).update({estado, motivoRechazo: motivo});
  alert("Estado actualizado");
  cargarSolicitudes();
  cerrarModal();
}

function cerrarModal(){ document.getElementById("modalDetalle").style.display="none"; }

// CARGAR SELECTS
async function cargarGerenciasSolicitudes(){
  const snapshot = await db.collection("gerencias").get();
  const sel = document.getElementById("solGerencia");
  const depSel = document.getElementById("depGerenciaSelect");
  sel.innerHTML='<option value="">Seleccione Gerencia</option>';
  depSel.innerHTML='<option value="">Seleccione Gerencia</option>';
  snapshot.forEach(doc=>{
    const d = doc.data();
    sel.innerHTML += `<option value="${d.nombre}">${d.nombre}</option>`;
    depSel.innerHTML += `<option value="${d.nombre}">${d.nombre}</option>`;
  });
}
async function cargarDepartamentosSolicitudes(){
  const snapshot = await db.collection("departamentos").get();
  const sel = document.getElementById("solDepartamento");
  sel.innerHTML='<option value="">Seleccione Departamento</option>';
  snapshot.forEach(doc=>{
    const d = doc.data();
    sel.innerHTML += `<option value="${d.nombre}">${d.nombre}</option>`;
  });
}
</script>
</body>
</html>