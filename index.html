<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | GestiÃ³n Documental</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;margin:0}
header{background:#0f172a;color:#fff;padding:15px}
section{padding:20px}
.card{background:#fff;padding:15px;margin-bottom:15px;border-radius:8px}
input,select,textarea,button{width:100%;margin:5px 0;padding:6px}
button{cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}
hr{margin:15px 0}
</style>
</head>

<body>

<header>
<h2>ğŸ“ Sistema de GestiÃ³n Documental FCI</h2>
<p>Modo abierto (sin login)</p>
</header>

<section>

<!-- DASHBOARD -->
<div class="card">
<button onclick="ver('solicitudes')">Solicitudes</button>
<button onclick="ver('usuarios')">Usuarios</button>
<button onclick="ver('gerencias')">Gerencias</button>
<button onclick="ver('departamentos')">Departamentos</button>
</div>

<!-- SOLICITUDES -->
<div id="solicitudes" class="card">
<h3>â• Nueva Solicitud</h3>

<select id="tipoDocumento">
<option>Procedimiento</option>
<option>GuÃ­a</option>
<option>Instructivo</option>
<option>Manual</option>
<option>Formato</option>
</select>

<input id="nombreDocumento" placeholder="Nombre del documento">

<select id="accion">
<option>CreaciÃ³n</option>
<option>ModificaciÃ³n</option>
<option>InactivaciÃ³n</option>
</select>

<input id="gerencia" placeholder="Gerencia">
<input id="departamento" placeholder="Departamento">
<textarea id="motivo" placeholder="Motivo"></textarea>

<hr>

<h4>Datos solo si es modificaciÃ³n / inactivaciÃ³n</h4>
<input type="date" id="fechaVersion">
<input id="ultimaVersion" placeholder="Ãšltima versiÃ³n">
<input id="codificacion" placeholder="CodificaciÃ³n">

<input type="file" id="archivo">
<button onclick="crearSolicitud()">Crear Solicitud</button>

<hr>

<h3>ğŸ“‹ Solicitudes</h3>
<table>
<thead>
<tr>
<th>CÃ³digo</th>
<th>Documento</th>
<th>Estado</th>
<th>Detalles</th>
</tr>
</thead>
<tbody id="tablaSolicitudes"></tbody>
</table>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="card" style="display:none">
<h3>ğŸ‘¤ Usuarios</h3>

<input id="uUsuario" placeholder="Usuario">
<input id="uCorreo" placeholder="Correo">
<select id="uRol">
<option>usuario</option>
<option>gerente</option>
<option>admin</option>
</select>
<input id="uGerencia" placeholder="Gerencia">
<input id="uDepto" placeholder="Departamento">
<button onclick="crearUsuario()">Guardar Usuario</button>

<ul id="listaUsuarios"></ul>
</div>

<!-- GERENCIAS -->
<div id="gerencias" class="card" style="display:none">
<h3>ğŸ¢ Gerencias</h3>
<input id="nGerencia" placeholder="Nueva gerencia">
<button onclick="addGerencia()">Agregar</button>
<ul id="listaGerencias"></ul>
</div>

<!-- DEPARTAMENTOS -->
<div id="departamentos" class="card" style="display:none">
<h3>ğŸ¬ Departamentos</h3>
<input id="nDepto" placeholder="Departamento">
<input id="gDepto" placeholder="Gerencia">
<button onclick="addDepto()">Agregar</button>
<ul id="listaDeptos"></ul>
</div>

</section>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain:"sistemadegestion-7400d.firebaseapp.com",
  projectId:"sistemadegestion-7400d"
});
const db = firebase.firestore();

/* VISTAS */
function ver(id){
  ["solicitudes","usuarios","gerencias","departamentos"]
  .forEach(v=>document.getElementById(v).style.display="none");
  document.getElementById(id).style.display="block";
}

/* CLOUDINARY */
async function subirArchivo(file){
  const fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset","fci_documentos");
  const r=await fetch("https://api.cloudinary.com/v1_1/df79cjklp/auto/upload",{method:"POST",body:fd});
  const j=await r.json();
  return j.secure_url || "";
}

/* SOLICITUDES */
async function crearSolicitud(){
  let url="";
  if(archivo.files[0]) url=await subirArchivo(archivo.files[0]);

  const snap = await db.collection("solicitudes").get();
  const codigo = "FCI-SOL-" + String(snap.size+1).padStart(4,"0");

  await db.collection("solicitudes").add({
    codigo,
    tipo: tipoDocumento.value,
    nombre: nombreDocumento.value,
    accion: accion.value,
    gerencia: gerencia.value,
    departamento: departamento.value,
    motivo: motivo.value,
    fechaVersion: fechaVersion.value,
    ultimaVersion: ultimaVersion.value,
    codificacion: codificacion.value,
    archivo: url,
    estado: "Pendiente",
    historial:[{estado:"Pendiente",fecha:new Date().toISOString()}]
  });
  cargarSolicitudes();
}

async function cargarSolicitudes(){
  tablaSolicitudes.innerHTML="";
  const q=await db.collection("solicitudes").get();
  q.forEach(d=>{
    const s=d.data();
    tablaSolicitudes.innerHTML+=`
    <tr>
      <td>${s.codigo}</td>
      <td>${s.nombre}</td>
      <td>${s.estado}</td>
      <td><button onclick="alert(JSON.stringify(${JSON.stringify(s)},null,2))">Ver</button></td>
    </tr>`;
  });
}

/* USUARIOS */
async function crearUsuario(){
  await db.collection("usuarios").add({
    usuario:uUsuario.value,
    correo:uCorreo.value,
    rol:uRol.value,
    gerencia:uGerencia.value,
    departamento:uDepto.value
  });
  cargarUsuarios();
}
async function cargarUsuarios(){
  listaUsuarios.innerHTML="";
  const q=await db.collection("usuarios").get();
  q.forEach(d=>listaUsuarios.innerHTML+=`<li>${d.data().usuario} (${d.data().rol})</li>`);
}

/* GERENCIAS */
async function addGerencia(){
  await db.collection("gerencias").add({nombre:nGerencia.value});
  cargarGerencias();
}
async function cargarGerencias(){
  listaGerencias.innerHTML="";
  const q=await db.collection("gerencias").get();
  q.forEach(d=>listaGerencias.innerHTML+=`<li>${d.data().nombre}</li>`);
}

/* DEPARTAMENTOS */
async function addDepto(){
  await db.collection("departamentos").add({nombre:nDepto.value,gerencia:gDepto.value});
  cargarDeptos();
}
async function cargarDeptos(){
  listaDeptos.innerHTML="";
  const q=await db.collection("departamentos").get();
  q.forEach(d=>listaDeptos.innerHTML+=`<li>${d.data().nombre}</li>`);
}

/* INIT */
cargarSolicitudes();
cargarUsuarios();
cargarGerencias();
cargarDeptos();
</script>

</body>
</html>