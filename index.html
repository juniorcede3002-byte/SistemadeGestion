<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCI - Sistema de Gesti贸n Documental Integral</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #2D336B;
            --secondary: #5142E6;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f0f2f5;
            --dark: #333;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--light); color: var(--dark); }
        .hidden { display: none !important; }

        /* --- LOGIN --- */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--primary); }
        .login-card { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-login { width: 100%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* --- APP LAYOUT --- */
        .app-container { max-width: 1200px; margin: 20px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* NOTIFICACIONES */
        .nav-right { display: flex; align-items: center; gap: 20px; }
        .notif-wrapper { position: relative; cursor: pointer; font-size: 22px; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; }
        .notif-dropdown { position: absolute; top: 40px; right: 0; width: 300px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1000; max-height: 400px; overflow-y: auto; }
        .notif-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        .notif-item.unread { background: #edf2ff; border-left: 4px solid var(--secondary); }

        /* DASHBOARD */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #e0e6ed; }
        .stat-card p { font-size: 28px; font-weight: bold; margin: 5px 0; color: var(--secondary); }

        /* TABLAS Y BOTONES */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #666; }
        .btn-action { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 850px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }

        /* BADGES ESTADO */
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .status-pendiente { background: var(--warning); color: #000; }
        .status-revision { background: var(--info); color: #fff; }
        .status-aprobado { background: var(--success); color: #fff; }
        .status-rechazado { background: var(--danger); color: #fff; }
        
        .historial-box { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid var(--secondary); }
        .hist-item { margin-bottom: 10px; font-size: 13px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    </style>
</head>
<body>

<button onclick="crearPrimerAdmin()" style="position:fixed; bottom:10px; right:10px; z-index:9999; opacity:0.3">Setup Admin</button>

<div id="view-login" class="login-container">
    <div class="login-card">
        <h1 style="color: var(--primary)">FCI Logistix</h1>
        <p>Gesti贸n Documental SGC</p>
        <input type="text" id="loginUser" class="login-input" placeholder="Usuario">
        <input type="password" id="loginPass" class="login-input" placeholder="Contrase帽a">
        <button onclick="login()" class="btn-login">INGRESAR</button>
        <p id="loginError" style="color:red; font-size:13px; display:none;">Credenciales no v谩lidas</p>
    </div>
</div>

<div id="view-app" class="app-container hidden">
    <header>
        <div>
            <h2 style="margin:0;">Panel de Control</h2>
            <small id="userTag"></small>
        </div>
        <div class="nav-right">
            <div class="notif-wrapper" onclick="toggleNotifs()">
                 <span id="notif-count" class="badge hidden">0</span>
                <div id="notif-dropdown" class="notif-dropdown hidden">
                    <div style="padding:10px; background:var(--primary); color:white; font-weight:bold;">Notificaciones</div>
                    <div id="notif-list"></div>
                </div>
            </div>
            <button onclick="logout()" class="btn-action btn-danger">Salir</button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card"><h3>Total</h3><p id="st-total">0</p></div>
        <div class="stat-card"><h3>Pendientes</h3><p id="st-pendiente">0</p></div>
        <div class="stat-card"><h3>En Revisi贸n</h3><p id="st-revision">0</p></div>
        <div class="stat-card"><h3>Finalizados</h3><p id="st-finalizado">0</p></div>
    </div>

    <div id="section-admin" class="hidden">
        <h3 style="color:var(--secondary)">Gesti贸n de Usuarios y Estructura</h3>
        <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px; background:#fff; border:1px solid #ddd; padding:20px; border-radius:10px;">
            <div>
                <h4>Configuraci贸n Org.</h4>
                <input type="text" id="newGerencia" placeholder="Nueva Gerencia">
                <button onclick="addOrg('gerencias', 'newGerencia')" class="btn-action btn-primary" style="width:100%; margin-bottom:10px;">+ Gerencia</button>
                <select id="selGerenciaOrg" class="login-input"></select>
                <input type="text" id="newDepto" placeholder="Nuevo Departamento">
                <button onclick="addOrg('departamentos', 'newDepto', 'selGerenciaOrg')" class="btn-action btn-primary" style="width:100%;">+ Departamento</button>
            </div>
            <div>
                <h4>Registrar Usuario</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="uNom" placeholder="Nombre Login">
                    <input type="text" id="uMail" placeholder="Correo">
                    <input type="password" id="uPass" placeholder="Contrase帽a">
                    <select id="uGer" class="login-input"></select>
                </div>
                <div style="margin:10px 0;">
                    <label><input type="checkbox" id="p_ges"> Administrador</label>
                    <label><input type="checkbox" id="p_apr"> Aprobador Gerente</label>
                </div>
                <button onclick="registrarUsuario()" class="btn-action btn-success" style="width:100%;">GUARDAR USUARIO</button>
            </div>
        </div>
        <h4>Usuarios en Base de Datos</h4>
        <div class="table-responsive">
            <table id="table-users">
                <thead><tr><th>Nombre</th><th>Correo</th><th>Gerencia</th><th>Rol</th><th>Acci贸n</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <section style="margin-top:40px;">
        <h3 style="color:var(--success)">Nueva Solicitud de Documento</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; background:#f4f7f6; padding:20px; border-radius:10px;">
            <input type="text" id="solTit" placeholder="T铆tulo del Documento">
            <select id="solTipo" class="login-input">
                <option>Procedimiento</option><option>Manual</option><option>Gu铆a</option><option>Instructivo</option><option>Formato</option>
            </select>
            <select id="solAcc" class="login-input">
                <option>Creaci贸n</option><option>Modificaci贸n</option><option>Inactivaci贸n</option>
            </select>
            <input type="text" id="solMot" placeholder="Motivo breve">
            <textarea id="solDesc" placeholder="Descripci贸n detallada de los cambios..." style="grid-column: span 2; padding:10px; border-radius:8px; border:1px solid #ddd;"></textarea>
            <input type="file" id="solFiles" multiple>
            <button onclick="crearSolicitud()" class="btn-action btn-success" style="grid-column: span 2; padding:15px;">ENVIAR A SISTEMA DE GESTIN</button>
        </div>

        <h3 style="margin-top:30px;">Historial de Solicitudes</h3>
        <div class="table-responsive">
            <table id="table-solicitudes">
                <thead><tr><th>ID</th><th>Documento</th><th>Solicitante</th><th>Estado</th><th>Acci贸n</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
</div>

<div id="modal-detalle" class="modal hidden">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 id="md-id" style="margin:0; color:var(--secondary)">FCI-XXXX</h2>
        <p id="md-tit" style="font-size:18px; font-weight:bold;"></p>
        <hr>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <p><strong>Tipo:</strong> <span id="md-tipo"></span></p>
                <p><strong>Acci贸n:</strong> <span id="md-acc"></span></p>
                <p><strong>Solicitante:</strong> <span id="md-user"></span></p>
                <p><strong>Ubicaci贸n:</strong> <span id="md-ub"></span></p>
            </div>
            <div>
                <p><strong>Estado:</strong> <span id="md-est" class="status-pill"></span></p>
                <p><strong>Motivo:</strong> <span id="md-mot"></span></p>
                <div id="md-links"></div>
            </div>
        </div>
        <div style="background:#eee; padding:15px; border-radius:8px; margin-top:10px;">
            <strong>Descripci贸n detallada:</strong><br><span id="md-desc"></span>
        </div>

        <div id="panel-interaccion" style="margin-top:20px; border:2px dashed var(--secondary); padding:20px; border-radius:10px;">
            <h4 style="margin-top:0;">Interacci贸n T茅cnica y Aprobaciones</h4>
            <div id="btns-estado" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
            
            <div id="form-accion" class="hidden" style="margin-top:15px; background: #fff3cd; padding:15px; border-radius:8px;">
                <label id="lbl-acc" style="font-weight:bold;"></label>
                <input type="text" id="txt-acc-motivo" class="login-input" placeholder="Escriba los detalles aqu铆...">
                <input type="date" id="date-acc" class="hidden login-input">
                <button id="btn-confirm-acc" class="btn-action btn-primary">Confirmar Movimiento</button>
            </div>
        </div>

        <div class="historial-box">
            <h4>Trazabilidad del Proceso</h4>
            <div id="md-historial"></div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURACIN FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.appspot.com",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Cloudinary
const cloudName = "df79cjklp";
const uploadPreset = "fci_documentos";

let currentUser = null;
let currentSolId = null;

// --- SISTEMA DE SESIN ---
function init() {
    const session = sessionStorage.getItem("fci_session");
    if(session) {
        currentUser = JSON.parse(session);
        showApp();
    }
}

async function login() {
    const u = document.getElementById("loginUser").value;
    const p = document.getElementById("loginPass").value;
    const snap = await db.collection("Users").where("nombre","==",u).where("pass","==",p).get();
    
    if(!snap.empty) {
        currentUser = { id: snap.docs[0].id, ...snap.docs[0].data() };
        sessionStorage.setItem("fci_session", JSON.stringify(currentUser));
        showApp();
    } else {
        document.getElementById("loginError").style.display = "block";
    }
}

function logout() { sessionStorage.clear(); location.reload(); }

function showApp() {
    document.getElementById("view-login").classList.add("hidden");
    document.getElementById("view-app").classList.remove("hidden");
    document.getElementById("userTag").innerText = `${currentUser.nombre} (${currentUser.gerencia})`;
    
    if(currentUser.permisos?.gestionar) document.getElementById("section-admin").classList.remove("hidden");
    
    loadData();
    listenNotifs();
}

// --- CARGA DE DATOS REALTIME ---
function loadData() {
    // Organigrama
    db.collection("gerencias").onSnapshot(s => {
        let h = ""; s.forEach(d => h+=`<option value="${d.data().nombre}">${d.data().nombre}</option>`);
        ["selGerenciaOrg","uGer"].forEach(id => document.getElementById(id).innerHTML = h);
    });

    // Usuarios
    db.collection("Users").onSnapshot(s => {
        let h = "";
        s.forEach(doc => {
            const u = doc.data();
            h += `<tr><td>${u.nombre}</td><td>${u.correo}</td><td>${u.gerencia}</td>
                  <td>${u.permisos.gestionar ? 'Admin':'Usuario'}</td>
                  <td><button onclick="delDoc('Users','${doc.id}')" class="btn-action btn-danger">X</button></td></tr>`;
        });
        document.querySelector("#table-users tbody").innerHTML = h;
    });

    // Solicitudes & Stats
    db.collection("solicitudes").orderBy("fecha","desc").onSnapshot(s => {
        let h = "";
        let st = {t:0, p:0, r:0, f:0};
        s.forEach(doc => {
            const d = doc.data();
            st.t++;
            if(d.estado == "Pendiente") st.p++;
            else if(d.estado == "Finalizado") st.f++;
            else st.r++;

            h += `<tr>
                <td><span class="status-pill" style="background:#333; color:white">${d.fciId}</span></td>
                <td><strong>${d.titulo}</strong><br><small>${d.tipo}</small></td>
                <td>${d.usuarioNom}</td>
                <td><span class="status-pill status-${d.estado.toLowerCase()}">${d.estado}</span></td>
                <td><button onclick="openDetalle('${doc.id}')" class="btn-action btn-primary">VER</button></td>
            </tr>`;
        });
        document.querySelector("#table-solicitudes tbody").innerHTML = h;
        document.getElementById("st-total").innerText = st.t;
        document.getElementById("st-pendiente").innerText = st.p;
        document.getElementById("st-revision").innerText = st.r;
        document.getElementById("st-finalizado").innerText = st.f;
    });
}

// --- CREACIN DE SOLICITUD ---
async function crearSolicitud() {
    const tit = document.getElementById("solTit").value;
    if(!tit) return alert("El t铆tulo es obligatorio");

    const btn = event.target;
    btn.disabled = true; btn.innerText = "Subiendo archivos...";

    let urls = [];
    const files = document.getElementById("solFiles").files;
    for(let f of files) {
        let fd = new FormData(); fd.append("file", f); fd.append("upload_preset", uploadPreset);
        let res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {method:"POST", body:fd});
        let j = await res.json(); urls.push(j.secure_url);
    }

    const idFci = await getNextFCI();
    const data = {
        fciId: idFci, titulo: tit,
        tipo: document.getElementById("solTipo").value,
        accion: document.getElementById("solAcc").value,
        motivo: document.getElementById("solMot").value,
        descripcion: document.getElementById("solDesc").value,
        documentos: urls,
        estado: "Pendiente",
        fecha: new Date(),
        usuarioNom: currentUser.nombre,
        usuarioGerencia: currentUser.gerencia,
        historial: [{fecha: new Date(), accion: "CREACIN", msg: "Solicitud ingresada al sistema"}]
    };

    await db.collection("solicitudes").add(data);
    alert("Solicitud creada con 茅xito: " + idFci);
    location.reload();
}

// --- LGICA DE DETALLE Y ESTADOS ---
async function openDetalle(id) {
    currentSolId = id;
    const doc = await db.collection("solicitudes").doc(id).get();
    const d = doc.data();

    document.getElementById("md-id").innerText = d.fciId;
    document.getElementById("md-tit").innerText = d.titulo;
    document.getElementById("md-tipo").innerText = d.tipo;
    document.getElementById("md-acc").innerText = d.accion;
    document.getElementById("md-user").innerText = d.usuarioNom;
    document.getElementById("md-ub").innerText = d.usuarioGerencia;
    document.getElementById("md-est").innerText = d.estado;
    document.getElementById("md-est").className = "status-pill status-" + d.estado.toLowerCase();
    document.getElementById("md-mot").innerText = d.motivo;
    document.getElementById("md-desc").innerText = d.descripcion;

    let l = ""; d.documentos.forEach((u,i) => l+=`<a href="${u}" target="_blank">Ver Adjunto ${i+1}</a> `);
    document.getElementById("md-links").innerHTML = l;

    let h = ""; d.historial.forEach(ev => {
        let f = ev.fecha.seconds ? new Date(ev.fecha.seconds*1000).toLocaleString() : new Date().toLocaleString();
        h += `<div class="hist-item"><strong>${f} - ${ev.accion}:</strong> ${ev.msg}</div>`;
    });
    document.getElementById("md-historial").innerHTML = h;

    renderButtons(d.estado);
    document.getElementById("modal-detalle").classList.remove("hidden");
}

function renderButtons(estado) {
    const div = document.getElementById("btns-estado");
    div.innerHTML = "";
    document.getElementById("form-accion").classList.add("hidden");

    if(!currentUser.permisos.gestionar) return;

    if(estado == "Pendiente") {
        div.innerHTML += `<button onclick="updateStatus('Revisi贸n','Se inicia an谩lisis t茅cnico')" class="btn-action btn-primary">Pasar a Revisi贸n</button>`;
    }
    if(estado == "Revisi贸n") {
        div.innerHTML += `<button onclick="prepAcc('Consulta','Motivo de la consulta t茅cnica')" class="btn-action" style="background:#6f42c1; color:white">Realizar Consulta</button>`;
        div.innerHTML += `<button onclick="prepAcc('Reuni贸n','Asunto y Fecha propuesta', true)" class="btn-action" style="background:#fd7e14; color:white">Citar a Reuni贸n</button>`;
        div.innerHTML += `<button onclick="updateStatus('Aprobaci贸n SGC','Documento verificado y firmado por SGC')" class="btn-action btn-success">Aprobado por SGC</button>`;
    }
    if(estado == "Aprobaci贸n SGC") {
        div.innerHTML += `<button onclick="updateStatus('Solicitud Gerencia','Esperando firma de Gerente de 谩rea')" class="btn-action btn-primary">Enviar a Gerente</button>`;
    }
    if(estado == "Solicitud Gerencia") {
        div.innerHTML += `<button onclick="updateStatus('Finalizado','Proceso completado')" class="btn-action btn-success">FINALIZAR</button>`;
        div.innerHTML += `<button onclick="prepAcc('Rechazado Gerencia','Motivo detallado del rechazo')" class="btn-action btn-danger">RECHAZAR</button>`;
    }
    if(estado == "Rechazado Gerencia") {
        div.innerHTML += `<button onclick="updateStatus('Solicitud Gerencia','Re-enviado tras correcciones')" class="btn-action btn-primary">Re-enviar a Gerente</button>`;
    }
}

function prepAcc(tipo, label, conFecha = false) {
    document.getElementById("form-accion").classList.remove("hidden");
    document.getElementById("lbl-acc").innerText = label;
    document.getElementById("date-acc").classList.toggle("hidden", !conFecha);
    document.getElementById("btn-confirm-acc").onclick = () => {
        let m = document.getElementById("txt-acc-motivo").value;
        let f = document.getElementById("date-acc").value;
        if(!m) return alert("Debe ingresar un comentario");
        updateStatus(tipo, m + (f ? " | Fecha: "+f : ""));
    };
}

async function updateStatus(nuevo, msg) {
    const snap = await db.collection("solicitudes").doc(currentSolId).get();
    const d = snap.data();
    let hist = d.historial;
    hist.push({fecha: new Date(), accion: nuevo, msg: msg});

    await db.collection("solicitudes").doc(currentSolId).update({ estado: nuevo, historial: hist });
    
    // Notificar
    await db.collection("Notificaciones").add({
        destinatario: d.usuarioNom,
        titulo: `Cambio en ${d.fciId}`,
        mensaje: `Tu solicitud pas贸 a ${nuevo}: ${msg}`,
        solId: currentSolId,
        leido: false,
        fecha: new Date()
    });

    closeModal();
}

// --- NOTIFICACIONES ---
function toggleNotifs() {
    const d = document.getElementById("notif-dropdown");
    d.classList.toggle("hidden");
    if(!d.classList.contains("hidden")) markRead();
}

function listenNotifs() {
    db.collection("Notificaciones").where("destinatario","==",currentUser.nombre)
      .orderBy("fecha","desc").limit(10).onSnapshot(s => {
        let h = ""; let c = 0;
        s.forEach(doc => {
            const n = doc.data();
            if(!n.leido) c++;
            h += `<div class="notif-item ${!n.leido?'unread':''}" onclick="openDetalle('${n.solId}')">
                    <strong>${n.titulo}</strong><br>${n.mensaje}</div>`;
        });
        document.getElementById("notif-list").innerHTML = h || "<p style='padding:10px'>Sin notificaciones</p>";
        const b = document.getElementById("notif-count");
        if(c > 0) { b.innerText = c; b.classList.remove("hidden"); } else { b.classList.add("hidden"); }
      });
}

async function markRead() {
    const s = await db.collection("Notificaciones").where("destinatario","==",currentUser.nombre).where("leido","==",false).get();
    let batch = db.batch();
    s.forEach(d => batch.update(d.ref, {leido:true}));
    await batch.commit();
}

// --- UTILIDADES ---
async function getNextFCI() {
    const ref = db.collection("config").doc("correlativo");
    return db.runTransaction(async (t) => {
        const d = await t.get(ref);
        const n = d.exists ? d.data().val + 1 : 1;
        t.set(ref, {val: n});
        return "FCI-SGD-" + n.toString().padStart(4, '0');
    });
}

async function registrarUsuario() {
    await db.collection("Users").add({
        nombre: document.getElementById("uNom").value,
        correo: document.getElementById("uMail").value,
        pass: document.getElementById("uPass").value,
        gerencia: document.getElementById("uGer").value,
        permisos: { gestionar: document.getElementById("p_ges").checked, aprobar: document.getElementById("p_apr").checked }
    });
    alert("Usuario registrado");
}

function addOrg(col, inpId, parentId = null) {
    const val = document.getElementById(inpId).value;
    const data = { nombre: val };
    if(parentId) data.padre = document.getElementById(parentId).value;
    db.collection(col).add(data);
    document.getElementById(inpId).value = "";
}

function delDoc(c, id) { if(confirm("驴Eliminar?")) db.collection(c).doc(id).delete(); }
function closeModal() { document.getElementById("modal-detalle").classList.add("hidden"); }

async function crearPrimerAdmin() {
    await db.collection("Users").add({
        nombre: "Admin", pass: "123456", correo: "admin@fci.com", gerencia: "SGC",
        permisos: { gestionar: true, aprobar: true }
    });
    alert("Admin: Admin / 123456");
}

init();
</script>
</body>
</html>
