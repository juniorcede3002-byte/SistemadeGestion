<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI LOGISTIX | Sistema de Gestión Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{
  --p:#1a237e;--s:#3949ab;--ok:#2e7d32;--bad:#c62828;--bg:#f4f7f9;
}
body{margin:0;font-family:Segoe UI;background:var(--bg)}
.hidden{display:none}
header{background:var(--p);color:#fff;padding:12px 20px;display:flex;justify-content:space-between}
.tabs{background:#fff;display:flex;border-bottom:1px solid #ddd}
.tab{padding:14px 18px;cursor:pointer;font-weight:600}
.tab.active{color:var(--p);border-bottom:3px solid var(--p);background:#eef}
.content{padding:20px;max-width:1200px;margin:auto}
.card{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
input,select,textarea{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:6px}
button{padding:10px 16px;border:none;border-radius:6px;font-weight:600;cursor:pointer}
.btn-p{background:var(--p);color:#fff}
.btn-s{background:var(--ok);color:#fff}
.btn-d{background:var(--bad);color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee}
.badge{padding:4px 10px;border-radius:20px;font-size:11px}
.Pendiente{background:#fff3e0;color:#ef6c00}
.Finalizado{background:#e8f5e9;color:#2e7d32}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:2000}
.modal-body{background:#fff;padding:25px;border-radius:12px;width:90%;max-width:700px;max-height:90vh;overflow:auto}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" style="height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a237e,#3949ab)">
<div class="card" style="width:340px;text-align:center">
<h2 style="color:#1a237e">FCI LOGISTIX</h2>
<input id="l-user" placeholder="Usuario">
<input id="l-pass" type="password" placeholder="Contraseña" style="margin-top:10px">
<button class="btn-p" style="width:100%;margin-top:15px" onclick="login()">INGRESAR</button>

<!-- BOTÓN ADMIN EMERGENCIA -->
<button onclick="crearAdminInicial()" style="margin-top:15px;background:none;border:none;color:#aaa;font-size:11px">
⚡ Crear usuario admin (uso único)
</button>
</div>
</div>

<!-- APP -->
<div id="app" class="hidden">
<header>
<div>
<strong>FCI | SGD</strong><br>
<small id="userInfo"></small>
</div>
<button class="btn-d" onclick="location.reload()">Salir</button>
</header>

<div class="tabs">
<div class="tab active" onclick="tab(this,'sol')">Solicitudes</div>
<div class="tab admin" onclick="tab(this,'users')">Usuarios</div>
<div class="tab admin" onclick="tab(this,'org')">Organización</div>
</div>

<div class="content">

<!-- SOLICITUDES -->
<div id="t-sol">
<button class="btn-s" onclick="openModal('m-sol')">+ Nueva Solicitud</button>
<div class="card">
<table>
<thead><tr><th>ID</th><th>Documento</th><th>Estado</th><th>Acción</th></tr></thead>
<tbody id="listSol"></tbody>
</table>
</div>
</div>

<!-- USUARIOS -->
<div id="t-users" class="hidden">
<div class="card">
<h3>Crear Usuario</h3>
<input id="u-name" placeholder="Nombre">
<input id="u-user" placeholder="Usuario">
<input id="u-pass" placeholder="Contraseña">
<select id="u-rol">
<option>Usuario</option><option>Gerente</option><option>Admin</option>
</select>
<select id="u-ger"></select>
<button class="btn-p" onclick="crearUsuario()">Guardar</button>
</div>

<div class="card">
<table>
<thead><tr><th>Nombre</th><th>Rol</th><th>Gerencia</th><th>Eliminar</th></tr></thead>
<tbody id="listUsers"></tbody>
</table>
</div>
</div>

<!-- ORG -->
<div id="t-org" class="hidden">
<div class="card">
<h3>Gerencias</h3>
<input id="g-name"><button onclick="addGer()">+</button>
<ul id="gerList"></ul>
</div>
<div class="card">
<h3>Departamentos</h3>
<select id="d-parent"></select>
<input id="d-name"><button onclick="addDep()">+</button>
<ul id="depList"></ul>
</div>
</div>

</div>
</div>

<!-- MODAL SOL -->
<div id="m-sol" class="modal hidden">
<div class="modal-body">
<h3>Nueva Solicitud</h3>
<input id="s-doc" placeholder="Nombre Documento">
<select id="s-tipo">
<option>Procedimiento</option><option>Manual</option><option>Guía</option><option>Formato</option>
</select>
<textarea id="s-motivo" placeholder="Motivo"></textarea>
<input id="s-file" placeholder="URL Documento (Cloudinary)">
<button class="btn-s" onclick="crearSolicitud()">Enviar</button>
<button onclick="closeModal()">Cerrar</button>
</div>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
authDomain:"sistemadegestion-7400d.firebaseapp.com",
projectId:"sistemadegestion-7400d"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let user=null;

async function crearAdminInicial(){
const q=await db.collection("Users").where("user","==","admin").get();
if(!q.empty){alert("Admin ya existe");return;}
await db.collection("Users").add({nombre:"Administrador",user:"admin",pass:"123456",rol:"Admin",gerencia:"SGC"});
alert("Admin creado: admin / 123456");
}

async function login(){
const u=l-user.value,p=l-pass.value;
const q=await db.collection("Users").where("user","==",u).where("pass","==",p).get();
if(q.empty){alert("Credenciales incorrectas");return;}
user={id:q.docs[0].id,...q.docs[0].data()};
login.classList.add("hidden");app.classList.remove("hidden");
userInfo.innerText=user.nombre+" | "+user.rol;
if(user.rol!=="Admin")document.querySelectorAll(".admin").forEach(e=>e.remove());
load();
}

function tab(el,id){
document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
document.querySelectorAll("[id^='t-']").forEach(d=>d.classList.add("hidden"));
el.classList.add("active");document.getElementById("t-"+id).classList.remove("hidden");
}

function openModal(id){document.getElementById(id).classList.remove("hidden")}
function closeModal(){document.querySelectorAll(".modal").forEach(m=>m.classList.add("hidden"))}

async function crearUsuario(){
await db.collection("Users").add({
nombre:u-name.value,user:u-user.value,pass:u-pass.value,rol:u-rol.value,gerencia:u-ger.value
});
alert("Usuario creado");
}

async function crearSolicitud(){
await db.collection("Solicitudes").add({
doc:s-doc.value,tipo:s-tipo.value,motivo:s-motivo.value,
file:s-file.value,estado:"Pendiente",
user:user.nombre,uid:user.id,fecha:new Date()
});
closeModal();
}

function load(){
db.collection("Users").onSnapshot(s=>{
listUsers.innerHTML="";
s.forEach(d=>listUsers.innerHTML+=`<tr><td>${d.data().nombre}</td><td>${d.data().rol}</td><td>${d.data().gerencia}</td><td><button onclick="db.collection('Users').doc('${d.id}').delete()">X</button></td></tr>`);
});
db.collection("Solicitudes").onSnapshot(s=>{
listSol.innerHTML="";
s.forEach(d=>listSol.innerHTML+=`<tr><td>${d.id}</td><td>${d.data().doc}</td><td><span class="badge ${d.data().estado}">${d.data().estado}</span></td><td>Ver</td></tr>`);
});
db.collection("gerencias").onSnapshot(s=>{
u-ger.innerHTML=d-parent.innerHTML="";
gerList.innerHTML="";
s.forEach(d=>{
u-ger.innerHTML+=`<option>${d.data().nombre}</option>`;
d-parent.innerHTML+=`<option>${d.data().nombre}</option>`;
gerList.innerHTML+=`<li>${d.data().nombre}</li>`;
});
});
db.collection("departamentos").onSnapshot(s=>{
depList.innerHTML="";
s.forEach(d=>depList.innerHTML+=`<li>${d.data().nombre} (${d.data().parent})</li>`);
});
}

function addGer(){db.collection("gerencias").add({nombre:g-name.value})}
function addDep(){db.collection("departamentos").add({nombre:d-name.value,parent:d-parent.value})}
</script>
</body>
</html>