<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGC Pro Platinum | Gestión Documental</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e40af; --accent: #3b82f6; --bg: #f1f5f9;
            --success: #059669; --warning: #d97706; --danger: #dc2626;
            --white: #ffffff; --border: #cbd5e1; --sidebar: #0f172a;
            --text-main: #1e293b; --text-muted: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* Pantalla de Carga/Login */
        #login-screen { position: fixed; inset: 0; background: var(--sidebar); display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .login-box { background: var(--white); padding: 40px; border-radius: 24px; width: 100%; max-width: 420px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); text-align: center; margin: 20px; }

        /* Sidebar */
        .sidebar { width: 280px; background: var(--sidebar); color: white; display: none; flex-direction: column; padding: 20px; transition: all 0.3s; }
        .nav-link { 
            display: none; align-items: center; padding: 12px 16px; color: #94a3b8; border: none; 
            background: none; cursor: pointer; width: 100%; border-radius: 12px; margin-bottom: 5px; transition: 0.3s; font-size: 14px;
        }
        .nav-link.visible { display: flex; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link.active { background: var(--accent); color: white; font-weight: 600; }
        .nav-link span { margin-right: 12px; font-size: 20px; }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .section { display: none; max-width: 1200px; margin: 0 auto; }
        .section.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        h2 { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; display: block; }
        
        input, select, textarea { 
            width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 10px; 
            margin-bottom: 15px; font-size: 14px; background: #fff;
        }

        .file-upload-zone {
            border: 2px dashed var(--border); border-radius: 12px; padding: 20px; text-align: center;
            background: #f8fafc; cursor: pointer; transition: 0.2s; margin-bottom: 15px;
        }
        .file-upload-zone:hover { border-color: var(--accent); background: #f1f7ff; }
        #file-list { margin-bottom: 15px; }
        .file-item { display: flex; align-items: center; justify-content: space-between; background: #e2e8f0; padding: 8px 12px; border-radius: 8px; font-size: 11px; margin-bottom: 5px; }

        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid var(--border); font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .status-pendiente { background: #fef3c7; color: #92400e; }
        .status-aprobado { background: #d1fae5; color: #065f46; }
        .status-rechazado { background: #fee2e2; color: #991b1b; }

        .field-conditional { display: none; }
        .field-conditional.show { display: block; }
        
        #auth-loading { display: flex; flex-direction: column; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div id="auth-loading">
                <div class="spinner"></div>
                <p style="font-size: 12px; color: var(--text-muted)">Iniciando servicios seguros...</p>
            </div>
            <div id="login-form" style="display:none;">
                <span class="material-icons-round" style="font-size: 48px; color: var(--accent);">verified_user</span>
                <h1>SGC PRO PLATINUM</h1>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 25px;">Gestión Documental Conectada</p>
                <div style="text-align: left;">
                    <label>Usuario</label>
                    <input type="text" id="login-user" placeholder="admin">
                    <label>Contraseña</label>
                    <input type="password" id="login-pass" placeholder="••••">
                </div>
                <button class="btn btn-primary" id="btnLogin" style="width: 100%;">ENTRAR AL SISTEMA</button>
            </div>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div style="padding: 10px 0 30px 0; display:flex; align-items:center; gap:10px;">
            <div style="background:var(--accent); padding:6px; border-radius:8px;">
                <span class="material-icons-round" style="color: white; margin:0; font-size: 24px;">description</span>
            </div>
            <h2 style="color: white; margin:0; font-size: 18px;">SGC PLATINUM</h2>
        </div>
        
        <nav style="flex:1">
            <button class="nav-link" id="nav-dash" onclick="cambiarVista('sec-dash', this)">
                <span class="material-icons-round">dashboard</span> Inicio
            </button>
            <button class="nav-link" id="nav-crear" onclick="cambiarVista('sec-crear', this)">
                <span class="material-icons-round">add_circle</span> Nueva Solicitud
            </button>
            <button class="nav-link" id="nav-hist" onclick="cambiarVista('sec-hist', this)">
                <span class="material-icons-round">history</span> Mis Solicitudes
            </button>
            <button class="nav-link" id="nav-gest" onclick="cambiarVista('sec-gest', this)">
                <span class="material-icons-round">fact_check</span> Gestión SGC
            </button>
            <button class="nav-link" id="nav-users" onclick="cambiarVista('sec-users', this)">
                <span class="material-icons-round">people</span> Usuarios
            </button>
            <button class="nav-link" id="nav-struct" onclick="cambiarVista('sec-struct', this)">
                <span class="material-icons-round">lan</span> Estructura
            </button>
        </nav>
        
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
            <p id="curr-name" style="font-weight: 700; font-size: 13px;"></p>
            <p id="curr-ger" style="font-size: 10px; color: #94a3b8;"></p>
            <button onclick="location.reload()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:10px; display: flex; align-items: center; gap: 5px; margin-top: 12px; font-weight: 700;">
                <span class="material-icons-round" style="font-size:14px;">logout</span> SALIR
            </button>
        </div>
    </aside>

    <main class="main" id="main">
        <section id="sec-dash" class="section">
            <h2>Dashboard</h2>
            <div class="grid-3">
                <div class="card"><label>Total Sistema</label><h1 id="count-total">0</h1></div>
                <div class="card"><label>Pendientes</label><h1 id="count-pend" style="color: var(--warning);">0</h1></div>
                <div class="card"><label>Mis Docs</label><h1 id="count-user" style="color: var(--accent);">0</h1></div>
            </div>
        </section>

        <section id="sec-crear" class="section">
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <h2>Nueva Solicitud</h2>
                <div class="grid-2">
                    <div>
                        <label>Tipo de Acción</label>
                        <select id="sol-accion" onchange="toggleForm()">
                            <option value="Creación">Creación</option>
                            <option value="Modificación">Modificación</option>
                            <option value="Inactivación">Inactivación</option>
                        </select>
                    </div>
                    <div><label>Nombre del Documento</label><input type="text" id="sol-tit"></div>
                </div>
                <div id="campos-extra" class="field-conditional">
                    <div class="grid-3">
                        <div><label>Código</label><input type="text" id="sol-cod"></div>
                        <div><label>Versión</label><input type="text" id="sol-ver"></div>
                        <div><label>Última Fecha</label><input type="date" id="sol-fec-u"></div>
                    </div>
                </div>
                <div class="grid-2">
                    <div><label>Gerencia</label><select id="sol-ger"></select></div>
                    <div><label>Departamento</label><select id="sol-dep"></select></div>
                </div>
                <label>Justificación</label>
                <textarea id="sol-motivo" rows="3"></textarea>
                <label>Adjuntar Archivos de PC</label>
                <div class="file-upload-zone" onclick="document.getElementById('file-input').click()">
                    <span class="material-icons-round">upload_file</span>
                    <p>Haz clic para simular la subida de documentos</p>
                    <input type="file" id="file-input" hidden multiple onchange="handleFiles(this.files)">
                </div>
                <div id="file-list"></div>
                <button class="btn btn-primary" id="btnEnviar" style="width:100%">ENVIAR SOLICITUD</button>
            </div>
        </section>

        <section id="sec-hist" class="section">
            <h2>Mis Solicitudes</h2>
            <div class="card" style="padding:0; overflow: hidden;">
                <table>
                    <thead><tr><th>Fecha</th><th>Documento</th><th>Acción</th><th>Adjuntos</th><th>Estado</th></tr></thead>
                    <tbody id="tb-hist"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-gest" class="section">
            <h2>Bandeja SGC</h2>
            <div class="card" style="padding:0;">
                <table>
                    <thead><tr><th>Solicitante</th><th>Documento</th><th>Archivos</th><th>Decisión</th></tr></thead>
                    <tbody id="tb-gest"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-users" class="section">
            <div class="grid-2">
                <div class="card">
                    <h2>Nuevo Usuario</h2>
                    <label>Nombre</label><input type="text" id="u-nom">
                    <label>ID / Login</label><input type="text" id="u-id">
                    <label>Contraseña</label><input type="password" id="u-pass">
                    <label>Gerencia</label><select id="u-ger-sel"></select>
                    <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 11px;">
                        <div><input type="checkbox" id="p_ver_ger"> Ver solicitudes de mi gerencia</div>
                        <div><input type="checkbox" id="p_gest"> Gestionar Bandeja SGC</div>
                        <div><input type="checkbox" id="p_admin"> Administrador Maestro</div>
                    </div>
                    <button class="btn btn-primary" id="btnSaveUser" style="width:100%; margin-top:15px;">CREAR</button>
                </div>
                <div class="card" style="padding:0"><table id="table-users"><thead><tr><th>User</th><th>Gerencia</th><th>Rol</th><th>Acción</th></tr></thead><tbody id="tb-users"></tbody></table></div>
            </div>
        </section>

        <section id="sec-struct" class="section">
            <div class="grid-2">
                <div class="card">
                    <h2>Gerencias</h2>
                    <div style="display:flex; gap:10px;"><input type="text" id="g-nom" style="margin:0;"><button class="btn btn-success" id="btnSaveGer">AÑADIR</button></div>
                    <div id="list-ger" style="margin-top:15px;"></div>
                </div>
                <div class="card">
                    <h2>Departamentos</h2>
                    <div style="display:flex; gap:10px;"><input type="text" id="d-nom" style="margin:0;"><button class="btn btn-success" id="btnSaveDep">AÑADIR</button></div>
                    <div id="list-dep" style="margin-top:15px;"></div>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, query, where, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // CONFIGURACIÓN OBLIGATORIA
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sgc-app';

        let currentUser = null;
        let selectedFiles = [];

        // Inicializar Autenticación (REGLA 3)
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                document.getElementById('auth-loading').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            } catch (e) {
                console.error("Auth error", e);
                alert("Error crítico de conexión. Por favor recarga.");
            }
        };
        initAuth();

        window.cambiarVista = (id, btn) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(btn) btn.classList.add('active');
        };

        window.toggleForm = () => {
            const acc = document.getElementById('sol-accion').value;
            const extra = document.getElementById('campos-extra');
            (acc !== 'Creación') ? extra.classList.add('show') : extra.classList.remove('show');
        };

        window.handleFiles = (files) => {
            selectedFiles = Array.from(files).map(f => ({ name: f.name, size: (f.size / 1024).toFixed(1) + 'KB', type: f.type }));
            document.getElementById('file-list').innerHTML = selectedFiles.map(f => `<div class="file-item"><span>${f.name}</span> <small>${f.size}</small></div>`).join('');
        };

        // LOGIN
        document.getElementById('btnLogin').onclick = async () => {
            const u = document.getElementById('login-user').value.toLowerCase().trim();
            const p = document.getElementById('login-pass').value;

            if(u === 'admin' && p === '1130') {
                currentUser = { nombre: "Administrador Maestro", usuario: "admin", gerencia: "SGC Central", p_admin: true, p_gest: true };
                setupUI(currentUser);
                return;
            }

            const qUsers = query(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios'));
            const snapshot = await getDocs(qUsers);
            let found = false;
            snapshot.forEach(doc => {
                const userData = doc.data();
                if(userData.usuario === u && userData.pass === p) {
                    currentUser = userData;
                    found = true;
                }
            });

            if(found) setupUI(currentUser);
            else alert("Acceso denegado.");
        };

        function setupUI(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main').style.display = 'block';
            document.getElementById('curr-name').innerText = user.nombre;
            document.getElementById('curr-ger').innerText = user.gerencia;

            const links = {
                'nav-dash': true, 'nav-crear': true, 'nav-hist': true,
                'nav-gest': user.p_gest || user.p_admin,
                'nav-users': user.p_admin,
                'nav-struct': user.p_admin
            };

            for(let id in links) if(links[id]) document.getElementById(id).classList.add('visible');
            cambiarVista('sec-dash', document.getElementById('nav-dash'));
            syncData();
        }

        function syncData() {
            if(!auth.currentUser) return;
            const ref = (c) => collection(db, 'artifacts', appId, 'public', 'data', c);

            // Escuchadores de datos
            onSnapshot(ref("Gerencias"), s => {
                let html = ""; let opts = "";
                s.forEach(d => {
                    const data = d.data();
                    html += `<div class="file-item">${data.nombre} <button onclick="window.deleteItem('Gerencias','${d.id}')" style="border:none;background:none;color:red;cursor:pointer">✖</button></div>`;
                    opts += `<option value="${data.nombre}">${data.nombre}</option>`;
                });
                document.getElementById('list-ger').innerHTML = html;
                document.getElementById('sol-ger').innerHTML = opts;
                document.getElementById('u-ger-sel').innerHTML = opts;
            }, (e) => console.log(e));

            onSnapshot(ref("Departamentos"), s => {
                let html = ""; let opts = "";
                s.forEach(d => {
                    html += `<div class="file-item">${d.data().nombre} <button onclick="window.deleteItem('Departamentos','${d.id}')" style="border:none;background:none;color:red;cursor:pointer">✖</button></div>`;
                    opts += `<option value="${d.data().nombre}">${d.data().nombre}</option>`;
                });
                document.getElementById('list-dep').innerHTML = html;
                document.getElementById('sol-dep').innerHTML = opts;
            });

            onSnapshot(ref("Usuarios"), s => {
                const tb = document.getElementById('tb-users'); tb.innerHTML = "";
                s.forEach(d => {
                    const u = d.data();
                    tb.innerHTML += `<tr><td>${u.nombre}</td><td>${u.gerencia}</td><td>${u.p_admin?'Admin':'User'}</td><td><button onclick="window.deleteItem('Usuarios','${d.id}')" class="btn-danger" style="padding:4px">Eliminar</button></td></tr>`;
                });
            });

            onSnapshot(ref("Solicitudes"), s => {
                const th = document.getElementById('tb-hist'); th.innerHTML = "";
                const tg = document.getElementById('tb-gest'); tg.innerHTML = "";
                let counts = { total: 0, pend: 0, user: 0 };

                s.forEach(d => {
                    const sol = d.data();
                    counts.total++;
                    if(sol.estado === 'Pendiente') counts.pend++;

                    const date = sol.fecha ? new Date(sol.fecha).toLocaleDateString() : 'N/A';
                    const arch = sol.archivos ? sol.archivos.length : 0;

                    if(sol.user_id === currentUser.usuario || currentUser.p_admin || (currentUser.p_ver_ger && sol.gerencia === currentUser.gerencia)) {
                        if(sol.user_id === currentUser.usuario) counts.user++;
                        th.innerHTML += `<tr><td>${date}</td><td><b>${sol.titulo}</b></td><td>${sol.accion}</td><td>${arch} arch.</td><td><span class="badge status-${sol.estado.toLowerCase()}">${sol.estado}</span></td></tr>`;
                    }

                    if((currentUser.p_gest || currentUser.p_admin) && sol.estado === 'Pendiente') {
                        tg.innerHTML += `<tr><td>${sol.solicitante}</td><td>${sol.titulo}</td><td>${arch} archivos</td><td><button class="btn btn-success" onclick="window.updateStatus('${d.id}','Aprobado')">✔</button><button class="btn btn-danger" onclick="window.updateStatus('${d.id}','Rechazado')">✖</button></td></tr>`;
                    }
                });
                document.getElementById('count-total').innerText = counts.total;
                document.getElementById('count-pend').innerText = counts.pend;
                document.getElementById('count-user').innerText = counts.user;
            });
        }

        // Acciones Globales
        document.getElementById('btnEnviar').onclick = async () => {
            const btn = document.getElementById('btnEnviar');
            btn.disabled = true; btn.innerText = "Guardando...";
            const data = {
                titulo: document.getElementById('sol-tit').value,
                accion: document.getElementById('sol-accion').value,
                codigo: document.getElementById('sol-cod').value,
                version: document.getElementById('sol-ver').value,
                gerencia: document.getElementById('sol-ger').value,
                departamento: document.getElementById('sol-dep').value,
                motivo: document.getElementById('sol-motivo').value,
                solicitante: currentUser.nombre,
                user_id: currentUser.usuario,
                archivos: selectedFiles,
                fecha: new Date().toISOString(),
                estado: "Pendiente"
            };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'Solicitudes'), data);
            btn.disabled = false; btn.innerText = "ENVIAR SOLICITUD";
            selectedFiles = []; document.getElementById('file-list').innerHTML = "";
            cambiarVista('sec-hist', document.getElementById('nav-hist'));
        };

        document.getElementById('btnSaveUser').onclick = async () => {
            const uid = document.getElementById('u-id').value.trim().toLowerCase();
            const data = {
                usuario: uid,
                nombre: document.getElementById('u-nom').value,
                pass: document.getElementById('u-pass').value,
                gerencia: document.getElementById('u-ger-sel').value,
                p_ver_ger: document.getElementById('p_ver_ger').checked,
                p_gest: document.getElementById('p_gest').checked,
                p_admin: document.getElementById('p_admin').checked
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', uid), data);
            alert("Usuario creado");
        };

        document.getElementById('btnSaveGer').onclick = async () => {
            const n = document.getElementById('g-nom').value;
            if(n) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'Gerencias'), { nombre: n });
            document.getElementById('g-nom').value = "";
        };

        document.getElementById('btnSaveDep').onclick = async () => {
            const n = document.getElementById('d-nom').value;
            if(n) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'Departamentos'), { nombre: n });
            document.getElementById('d-nom').value = "";
        };

        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Solicitudes', id), { estado: status });
        };

        window.deleteItem = async (coll, id) => {
            if(confirm("¿Eliminar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id));
        };

    </script>
</body>
</html>
