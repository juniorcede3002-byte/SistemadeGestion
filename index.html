<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | Gesti√≥n Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;margin:0}
header{background:#111827;color:#fff;padding:15px}
.card{background:#fff;padding:15px;margin:15px;border-radius:8px}
input,select,textarea,button{width:100%;margin-top:8px;padding:8px;border-radius:4px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer;margin-top:8px}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ccc;padding:6px;text-align:left}
h3,h4{margin-top:0}
.hidden{display:none}
</style>
</head>
<body>

<header>
<h2>üìÑ FCI ‚Äì Sistema de Solicitudes Documentales (Demo)</h2>
</header>

<!-- LOGIN -->
<div id="loginPanel" class="card">
<h3>üîë Login</h3>
<input id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase√±a">
<button onclick="login()">Ingresar</button>
<p id="loginError" style="color:red"></p>
</div>

<!-- PANEL PRINCIPAL -->
<section id="panel" class="card hidden">

<!-- ‚ûï CREAR SOLICITUD -->
<div class="card">
<h3>‚ûï Nueva Solicitud</h3>

<select id="tipoAccion">
<option>Creaci√≥n</option>
<option>Modificaci√≥n</option>
<option>Inactivaci√≥n</option>
</select>

<input id="nombreDocumento" placeholder="Nombre documento">

<select id="gerenciaSelect">
  <option value="">Selecciona gerencia</option>
</select>

<select id="departamentoSelect">
  <option value="">Selecciona departamento</option>
</select>

<textarea id="motivo" placeholder="Motivo"></textarea>

<input id="codificacion" placeholder="Codificaci√≥n actual">
<input id="ultimaVersion" placeholder="√öltima versi√≥n">
<input type="date" id="fechaUltimaVersion">

<input type="file" id="archivo">
<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>

<!-- üìã TABLA SOLICITUDES -->
<div class="card">
<h3>üìã Solicitudes</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>Documento</th>
<th>Estado</th>
<th>Acci√≥n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<!-- üõ† PANEL ADMIN -->
<div class="card">
<h3>‚öôÔ∏è Administraci√≥n</h3>

<h4>Usuarios</h4>
<input id="userCorreo" placeholder="Correo">
<input id="userNombre" placeholder="Usuario">
<input id="userPass" type="password" placeholder="Contrase√±a">
<select id="userRol">
  <option value="usuario">Usuario</option>
  <option value="gerente">Gerente</option>
  <option value="admin">Admin</option>
</select>
<select id="userGerencia">
  <option value="">Gerencia</option>
</select>
<button onclick="crearUsuario()">Agregar Usuario</button>
<ul id="listaUsuarios"></ul>

<h4>Gerencias</h4>
<input id="nuevaGerencia" placeholder="Nombre gerencia">
<button onclick="agregarGerencia()">Agregar Gerencia</button>
<ul id="listaGerencias"></ul>

<h4>Departamentos</h4>
<input id="nuevoDepartamento" placeholder="Nombre departamento">
<button onclick="agregarDepartamento()">Agregar Departamento</button>
<ul id="listaDepartamentos"></ul>

</div>

</section>

<script>
// ================= CONFIG FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
emailjs.init("2jVnfkJKKG0bpKN-U");

// ================= USUARIO ACTUAL =================
let usuarioActual = null;

// ================= LOGIN =================
async function login(){
  const userInput = document.getElementById("loginUser").value;
  const passInput = document.getElementById("loginPass").value;
  const loginError = document.getElementById("loginError");

  // Usuario Admin fijo
  if(userInput === "Admin" && passInput === "123456"){
    usuarioActual = {
      uid: "admin-001",
      usuario: "Admin",
      correo: "admin@fcipty.com",
      rol: "admin",
      gerencia: "Gerencia Demo",
      activo: true
    };
    loginError.innerText = "";
    document.getElementById("loginPanel").classList.add("hidden");
    document.getElementById("panel").classList.remove("hidden");
    cargarUsuarios(); cargarGerencias(); cargarDepartamentos(); cargarSolicitudes();
    return;
  }

  // Verificar usuarios creados manualmente
  const snap = await db.collection("users")
    .where("usuario","==",userInput)
    .where("password","==",passInput)
    .get();

  if(!snap.empty){
    usuarioActual = snap.docs[0].data();
    loginError.innerText="";
    document.getElementById("loginPanel").classList.add("hidden");
    document.getElementById("panel").classList.remove("hidden");
    cargarUsuarios(); cargarGerencias(); cargarDepartamentos(); cargarSolicitudes();
  } else {
    loginError.innerText="Usuario o contrase√±a incorrectos";
  }
}

// ================= FUNCIONES SOLICITUD =================
async function generarID(){
  const ref = db.collection("counters").doc("global");
  return db.runTransaction(async t=>{
    const d = await t.get(ref);
    let n = (d.exists ? d.data().solicitudes : 0) + 1;
    t.set(ref,{solicitudes:n},{merge:true});
    return "FCI-SOL-" + String(n).padStart(4,"0");
  });
}

async function subirArchivo(file){
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", "fci_unsigned");
  const res = await fetch("https://api.cloudinary.com/v1_1/df79cjklp/auto/upload",{method:"POST",body:form});
  const data = await res.json();
  return data.secure_url;
}

async function crearSolicitud(){
  if(!usuarioActual){ alert("Debes iniciar sesi√≥n"); return; }

  const archivoFile = document.getElementById("archivo").files[0];
  let url = null;
  if(archivoFile){
    try{ url = await subirArchivo(archivoFile); } 
    catch(err){ console.error("Error subiendo archivo:", err); alert("No se pudo subir el archivo"); return; }
  }

  const id = await generarID();
  const nuevaSolicitud = {
    idSolicitud:id,
    tipoAccion:document.getElementById("tipoAccion").value,
    nombreDocumento:document.getElementById("nombreDocumento").value,
    gerencia:document.getElementById("gerenciaSelect").value,
    departamento:document.getElementById("departamentoSelect").value,
    motivo:document.getElementById("motivo").value,
    codificacionActual:document.getElementById("codificacion").value || null,
    ultimaVersion:document.getElementById("ultimaVersion").value || null,
    fechaUltimaVersion:document.getElementById("fechaUltimaVersion").value || null,
    documento: url,
    estado:"pendiente",
    solicitante:{ uid:usuarioActual.uid, correo:usuarioActual.correo },
    fecha: firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("solicitudes").add(nuevaSolicitud);
  alert("Solicitud creada: "+id);
  cargarSolicitudes();
}

// ================= ADMINISTRACI√ìN =================
async function crearUsuario(){
  const correo = document.getElementById("userCorreo").value;
  const usuarioInput = document.getElementById("userNombre").value;
  const password = document.getElementById("userPass").value;
  const rol = document.getElementById("userRol").value;
  const gerencia = document.getElementById("userGerencia").value;

  if(!correo || !usuarioInput || !password){ alert("Todos los campos son obligatorios"); return; }

  await db.collection("users").add({correo, usuario:usuarioInput, password, rol, gerencia, activo:true});
  cargarUsuarios();
}

async function cargarUsuarios(){
  const ul = document.getElementById("listaUsuarios"); ul.innerHTML="";
  const snap = await db.collection("users").get();
  snap.forEach(d=>{
    const u = d.data();
    ul.innerHTML+=`<li>${u.usuario} (${u.correo}) - ${u.rol} - ${u.gerencia} <button onclick="eliminarUsuario('${d.id}')">Eliminar</button></li>`;
  });
}

async function eliminarUsuario(id){
  if(confirm("Eliminar usuario?")){
    await db.collection("users").doc(id).delete();
    cargarUsuarios();
  }
}

// ================= GERENCIAS =================
async function agregarGerencia(){
  const nombre=document.getElementById("nuevaGerencia").value; if(!nombre)return;
  await db.collection("gerencias").add({nombre}); cargarGerencias();
}
async function eliminarGerencia(id){ if(confirm("Eliminar gerencia?")){ await db.collection("gerencias").doc(id).delete(); cargarGerencias(); } }
async function cargarGerencias(){
  const ul=document.getElementById("listaGerencias");
  const selectUsuario=document.getElementById("userGerencia");
  const selectSolicitud=document.getElementById("gerenciaSelect");
  ul.innerHTML=""; selectUsuario.innerHTML=`<option value="">Selecciona gerencia</option>`; selectSolicitud.innerHTML=`<option value="">Selecciona gerencia</option>`;
  const snap=await db.collection("gerencias").get();
  snap.forEach(d=>{
    const g=d.data();
    ul.innerHTML+=`<li>${g.nombre} <button onclick="eliminarGerencia('${d.id}')">Eliminar</button></li>`;
    selectUsuario.innerHTML+=`<option value="${g.nombre}">${g.nombre}</option>`;
    selectSolicitud.innerHTML+=`<option value="${g.nombre}">${g.nombre}</option>`;
  });
}

// ================= DEPARTAMENTOS =================
async function agregarDepartamento(){
  const nombre=document.getElementById("nuevoDepartamento").value; if(!nombre)return;
  await db.collection("departamentos").add({nombre}); cargarDepartamentos();
}
async function eliminarDepartamento(id){ if(confirm("Eliminar departamento?")){ await db.collection("departamentos").doc(id).delete(); cargarDepartamentos(); } }
async function cargarDepartamentos(){
  const ul=document.getElementById("listaDepartamentos");
  const selectSolicitud=document.getElementById("departamentoSelect");
  ul.innerHTML=""; selectSolicitud.innerHTML=`<option value="">Selecciona departamento</option>`;
  const snap=await db.collection("departamentos").get();
  snap.forEach(d=>{
    const dep=d.data();
    ul.innerHTML+=`<li>${dep.nombre} <button onclick="eliminarDepartamento('${d.id}')">Eliminar</button></li>`;
    selectSolicitud.innerHTML+=`<option value="${dep.nombre}">${dep.nombre}</option>`;
  });
}

// ================= SOLICITUDES =================
async function cargarSolicitudes(){
  const tabla=document.getElementById("tabla");
  tabla.innerHTML="";
  const snap=await db.collection("solicitudes").get();
  snap.forEach(d=>{
    const s=d.data();
    tabla.innerHTML+=`<tr><td>${s.idSolicitud}</td><td>${s.nombreDocumento}</td><td>${s.estado}</td><td>-</td></tr>`;
  });
}
</script>
</body>
</html>
