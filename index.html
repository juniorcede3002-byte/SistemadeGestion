<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCI - Sistema de GestiÃ³n Documental</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 24px; border: 1px solid #e5e7eb; }
        .table-container { overflow-x: auto; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #1e293b; font-size: 0.85rem; }
        input, select, textarea { width: 100%; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; margin-top: 4px; outline: none; }
        input:focus { border-color: #3b82f6; ring: 2px solid #dbeafe; }
        button { border-radius: 8px; font-weight: 600; transition: all 0.2s; cursor: pointer; padding: 10px 18px; border: none; }
        .btn-primary { background: #2563eb; color: white; width: 100%; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-danger { background: #ef4444; color: white; padding: 5px 10px; font-size: 0.7rem; }
        .badge { padding: 4px 10px; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<div class="max-w-7xl mx-auto p-4 md:p-6">
    
    <header class="flex justify-between items-center mb-8 bg-slate-800 p-4 rounded-xl shadow-lg">
        <h1 class="text-xl font-bold text-white flex items-center gap-2">
            <span class="bg-blue-500 p-1 rounded">ğŸ“„</span> FCI GestiÃ³n Documental
        </h1>
        <div id="userInfo" class="hidden flex items-center gap-4 text-white">
            <div class="text-right border-r pr-4 border-slate-600">
                <p class="text-sm font-bold" id="currentUser"></p>
                <p class="text-[10px] uppercase tracking-widest text-blue-400" id="currentRole"></p>
            </div>
            <button onclick="logout()" class="text-xs bg-slate-700 hover:bg-red-600 px-3 py-1">Cerrar SesiÃ³n</button>
        </div>
    </header>

    <div id="loginDiv" class="max-w-md mx-auto mt-12 card">
        <h2 class="text-xl font-bold mb-6 text-center text-slate-800">Acceso al Sistema</h2>
        <div class="space-y-4">
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Usuario</label>
                <input type="text" id="loginUser" placeholder="Nombre de usuario">
            </div>
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase">ContraseÃ±a</label>
                <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button onclick="login()" class="btn-primary mt-4 py-3">Iniciar SesiÃ³n</button>
        </div>
    </div>

    <div id="appDiv" class="hidden space-y-6">
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="card">
                    <h3 class="font-bold text-blue-600 mb-4 flex items-center gap-2 border-b pb-2">ğŸ‘¤ Usuarios</h3>
                    <div class="space-y-2">
                        <input type="text" id="newUser" placeholder="Usuario" class="text-sm">
                        <input type="email" id="newEmail" placeholder="Correo" class="text-sm">
                        <input type="password" id="newPass" placeholder="Clave" class="text-sm">
                        <select id="newRole" class="text-sm">
                            <option value="user">Usuario</option>
                            <option value="gerente">Gerente</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button onclick="crearUsuario()" class="btn-primary py-2 text-sm">Registrar</button>
                    </div>
                    <div class="table-container mt-4 max-h-48 overflow-y-auto border rounded">
                        <table id="usersTable"><tbody></tbody></table>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-bold text-blue-600 mb-4 border-b pb-2">ğŸ¢ Estructura</h3>
                    <input type="text" id="newGerencia" placeholder="Nueva Gerencia" class="text-sm">
                    <button onclick="crearGerencia()" class="btn-primary py-1 mt-1 text-xs">Agregar Gerencia</button>
                    <div class="table-container mt-2 mb-4 max-h-32 overflow-y-auto border rounded">
                        <table id="gerenciasTable"></table>
                    </div>
                    <hr>
                    <input type="text" id="newDepartamento" placeholder="Nuevo Depto." class="text-sm mt-4">
                    <button onclick="crearDepartamento()" class="btn-primary py-1 mt-1 text-xs">Agregar Depto.</button>
                    <div class="table-container mt-2 max-h-32 overflow-y-auto border rounded">
                        <table id="departamentosTable"></table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                <div class="card bg-slate-50 border-blue-200 shadow-inner">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">âœ¨ Nueva Solicitud</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="selectGerencia"></select>
                        <select id="selectDepartamento"></select>
                        <textarea id="solMotivo" class="md:col-span-2" placeholder="Escriba el motivo aquÃ­..."></textarea>
                        <input type="file" id="solDocumento" class="bg-white">
                        <button onclick="crearSolicitud()" class="btn-primary bg-green-600 hover:bg-green-700">Enviar Solicitud</button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-bold text-slate-800 mb-4">ğŸ“‹ Listado de Solicitudes</h3>
                    <div class="table-container">
                        <table id="solicitudesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Solicitante</th>
                                    <th>Estructura</th>
                                    <th>Estado</th>
                                    <th>AcciÃ³n</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ğŸ”¹ FIREBASE CONFIG (Tus datos actualizados)
const firebaseConfig = {
Â  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
Â  authDomain: "sistemadegestion-7400d.firebaseapp.com",
Â  projectId: "sistemadegestion-7400d",
Â  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
Â  messagingSenderId: "709030283072",
Â  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

let currentUserData = null;

// ğŸ”¹ LOGIN
async function login() {
Â  const usuario = document.getElementById("loginUser").value;
Â  const pass = document.getElementById("loginPass").value;
Â  if(usuario === "Admin" && pass === "123456") {
Â  Â  currentUserData = {usuario:"Admin", correo:"admin@fci.com", role:"admin"};
Â  Â  mostrarApp(); return;
Â  }
Â  const snapshot = await db.collection("users").where("usuario","==",usuario).where("password","==",pass).get();
Â  if(!snapshot.empty){
Â  Â  const data = snapshot.docs[0].data();
Â  Â  currentUserData = {id:snapshot.docs[0].id,...data};
Â  Â  mostrarApp();
Â  } else { alert("Usuario o contraseÃ±a incorrectos"); }
}

function mostrarApp() {
Â  document.getElementById("loginDiv").classList.add("hidden");
Â  document.getElementById("appDiv").classList.remove("hidden");
Â  document.getElementById("userInfo").classList.remove("hidden");
Â  document.getElementById("currentUser").innerText = currentUserData.usuario;
Â  document.getElementById("currentRole").innerText = currentUserData.role;
Â  cargarUsuarios(); cargarGerencias(); cargarDepartamentos(); cargarSolicitudes();
}

function logout(){
Â  currentUserData = null;
Â  location.reload();
}

// ğŸ”¹ USUARIOS
async function crearUsuario(){
Â  const usuario = document.getElementById("newUser").value;
Â  const correo = document.getElementById("newEmail").value;
Â  const password = document.getElementById("newPass").value;
Â  const role = document.getElementById("newRole").value;
Â  if(!usuario || !correo || !password) return alert("Completa los campos");
Â  await db.collection("users").add({usuario, correo, password, role});
Â  cargarUsuarios();
}

async function cargarUsuarios(){
Â  const tbody = document.querySelector("#usersTable tbody");
Â  tbody.innerHTML = "";
Â  const snap = await db.collection("users").get();
Â  snap.forEach(doc => {
Â  Â  const data = doc.data();
Â  Â  tbody.innerHTML += `<tr><td class="font-bold">${data.usuario}</td><td>${data.role}</td><td><button class="btn-danger" onclick="eliminarUsuario('${doc.id}')">X</button></td></tr>`;
Â  });
}

async function eliminarUsuario(id){ if(confirm("Â¿Eliminar?")) { await db.collection("users").doc(id).delete(); cargarUsuarios(); } }

// ğŸ”¹ GERENCIAS
async function crearGerencia(){
Â  const nombre = document.getElementById("newGerencia").value;
Â  if(!nombre) return;
Â  await db.collection("gerencias").add({nombre});
Â  document.getElementById("newGerencia").value="";
Â  cargarGerencias();
}

async function cargarGerencias(){
Â  const table = document.getElementById("gerenciasTable");
Â  const select = document.getElementById("selectGerencia");
Â  table.innerHTML = ""; select.innerHTML = `<option value="">Seleccione Gerencia</option>`;
Â  const snap = await db.collection("gerencias").get();
Â  snap.forEach(doc=>{
Â  Â  const data=doc.data();
Â  Â  table.innerHTML += `<tr><td>${data.nombre}</td><td><button class="text-red-500" onclick="eliminarGerencia('${doc.id}')">âœ•</button></td></tr>`;
Â  Â  select.innerHTML += `<option value="${doc.id}">${data.nombre}</option>`;
Â  });
}

async function eliminarGerencia(id){ await db.collection("gerencias").doc(id).delete(); cargarGerencias(); }

// ğŸ”¹ DEPARTAMENTOS
async function crearDepartamento(){
Â  const nombre = document.getElementById("newDepartamento").value;
Â  if(!nombre) return;
Â  await db.collection("departamentos").add({nombre});
Â  document.getElementById("newDepartamento").value="";
Â  cargarDepartamentos();
}

async function cargarDepartamentos(){
Â  const table = document.getElementById("departamentosTable");
Â  const select = document.getElementById("selectDepartamento");
Â  table.innerHTML = ""; select.innerHTML = `<option value="">Seleccione Depto.</option>`;
Â  const snap = await db.collection("departamentos").get();
Â  snap.forEach(doc=>{
Â  Â  const data=doc.data();
Â  Â  table.innerHTML += `<tr><td>${data.nombre}</td><td><button class="text-red-500" onclick="eliminarDepartamento('${doc.id}')">âœ•</button></td></tr>`;
Â  Â  select.innerHTML += `<option value="${doc.id}">${data.nombre}</option>`;
Â  });
}

async function eliminarDepartamento(id){ await db.collection("departamentos").doc(id).delete(); cargarDepartamentos(); }

// ğŸ”¹ SOLICITUDES
async function crearSolicitud(){
Â  const gerenciaId = document.getElementById("selectGerencia").value;
Â  const departamentoId = document.getElementById("selectDepartamento").value;
Â  const motivo = document.getElementById("solMotivo").value;
Â  const file = document.getElementById("solDocumento").files[0];
Â  if(!gerenciaId || !departamentoId || !motivo) return alert("Completa los datos");

Â  let docUrl = "";
Â  if(file){
Â  Â  const ref = storage.ref('documentos/'+Date.now()+"_"+file.name);
Â  Â  await ref.put(file); docUrl = await ref.getDownloadURL();
Â  }

Â  const counterRef = db.collection("counters").doc("solicitudes");
Â  const counterDoc = await counterRef.get();
Â  let numero = (counterDoc.exists) ? counterDoc.data().count+1 : 1;
Â  await counterRef.set({count:numero});

Â  const solId = "FCI-SOL-"+String(numero).padStart(4,"0");
Â  await db.collection("solicitudes").doc(solId).set({
Â  Â  solId, usuario: currentUserData.usuario, correo: currentUserData.correo,
Â  Â  role: currentUserData.role, gerenciaId, departamentoId, motivo,
Â  Â  documento: docUrl, estado: "En Proceso", fecha: new Date()
Â  });
Â  alert("Solicitud Enviada");
Â  document.getElementById("solMotivo").value="";
Â  cargarSolicitudes();
}

async function cargarSolicitudes(){
Â  const tableBody = document.querySelector("#solicitudesTable tbody");
Â  tableBody.innerHTML = "";
Â  const snap = await db.collection("solicitudes").orderBy("fecha","desc").get();
Â  
Â  const gerSnap = await db.collection("gerencias").get();
Â  const depSnap = await db.collection("departamentos").get();
Â  const gers = {}; gerSnap.forEach(d=>gers[d.id]=d.data().nombre);
Â  const deps = {}; depSnap.forEach(d=>deps[d.id]=d.data().nombre);

Â  snap.forEach(doc=>{
Â  Â  const data = doc.data();
Â  Â  tableBody.innerHTML += `<tr>
Â  Â  Â  <td class="font-mono font-bold text-blue-600">${data.solId}</td>
Â  Â  Â  <td><p class="font-bold">${data.usuario}</p><p class="text-[10px] text-slate-400">${data.correo}</p></td>
Â  Â  Â  <td><p class="text-xs uppercase">${gers[data.gerenciaId]||''}</p><p class="text-[10px] text-slate-500">${deps[data.departamentoId]||''}</p></td>
Â  Â  Â  <td><span class="badge">${data.estado}</span></td>
Â  Â  Â  <td>
Â  Â  Â  Â  ${data.documento?`<a href="${data.documento}" target="_blank" class="text-blue-500 text-xs font-bold">ğŸ“‚ Ver</a>`:""}
Â  Â  Â  Â  ${currentUserData.role!=="user"?`<button onclick="cambiarEstado('${doc.id}')" class="ml-2 bg-slate-100 text-[10px] py-1 px-2 rounded hover:bg-slate-200">ESTADO</button>`:""}
Â  Â  Â  </td>
Â  Â  </tr>`;
Â  });
}

async function cambiarEstado(id){
Â  const nuevo = prompt("Nuevo estado (Pendiente, Revisado, Finalizado):");
Â  if(nuevo) { await db.collection("solicitudes").doc(id).update({estado:nuevo}); cargarSolicitudes(); }
}
</script>
</body>
</html>
