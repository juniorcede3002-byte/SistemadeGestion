<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGC Pro Platinum | Gestión Documental</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e40af; --accent: #3b82f6; --bg: #f1f5f9;
            --success: #059669; --warning: #d97706; --danger: #dc2626;
            --white: #ffffff; --border: #cbd5e1; --sidebar: #0f172a;
            --text-main: #1e293b; --text-muted: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* Pantalla de Carga/Login */
        #login-screen { position: fixed; inset: 0; background: var(--sidebar); display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .login-box { background: var(--white); padding: 40px; border-radius: 24px; width: 100%; max-width: 420px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); text-align: center; margin: 20px; }

        /* Sidebar */
        .sidebar { width: 280px; background: var(--sidebar); color: white; display: none; flex-direction: column; padding: 20px; transition: all 0.3s; }
        .nav-link { 
            display: none; align-items: center; padding: 12px 16px; color: #94a3b8; border: none; 
            background: none; cursor: pointer; width: 100%; border-radius: 12px; margin-bottom: 5px; transition: 0.3s; font-size: 14px;
        }
        .nav-link.visible { display: flex; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link.active { background: var(--accent); color: white; font-weight: 600; }
        .nav-link span { margin-right: 12px; font-size: 20px; }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .section { display: none; max-width: 1200px; margin: 0 auto; }
        .section.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        h2 { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; display: block; }
        
        input, select, textarea { 
            width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 10px; 
            margin-bottom: 15px; font-size: 14px; background: #fff;
        }

        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: #2563eb; color: white; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid var(--border); font-size: 11px; color: var(--text-muted); }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div id="auth-loading">
                <div class="spinner"></div>
                <p style="font-size: 12px; color: var(--text-muted)">Conectando al servidor seguro...</p>
            </div>
            <div id="login-form" style="display:none;">
                <span class="material-icons-round" style="font-size: 48px; color: var(--accent);">verified_user</span>
                <h1>SGC PRO PLATINUM</h1>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 25px;">Gestión de Solicitudes y Suministros</p>
                <div style="text-align: left;">
                    <label>Usuario</label>
                    <input type="text" id="login-user" placeholder="Ej: admin">
                    <label>Contraseña</label>
                    <input type="password" id="login-pass" placeholder="••••">
                </div>
                <button class="btn btn-primary" id="btnLogin" style="width: 100%;">INGRESAR</button>
            </div>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div style="padding: 10px 0 30px 0; display:flex; align-items:center; gap:10px;">
            <span class="material-icons-round" style="color: var(--accent); font-size: 32px;">description</span>
            <h2 style="color: white; margin:0;">SGC PLATINUM</h2>
        </div>
        
        <nav style="flex:1">
            <button class="nav-link visible" id="nav-dash" onclick="cambiarVista('sec-dash', this)">
                <span class="material-icons-round">dashboard</span> Inicio
            </button>
            <button class="nav-link visible" id="nav-stock" onclick="cambiarVista('sec-stock', this)">
                <span class="material-icons-round">inventory_2</span> Inventario
            </button>
            <button class="nav-link visible" id="nav-crear" onclick="cambiarVista('sec-crear', this)">
                <span class="material-icons-round">add_circle</span> Nueva Solicitud
            </button>
            <button class="nav-link visible" id="nav-hist" onclick="cambiarVista('sec-hist', this)">
                <span class="material-icons-round">history</span> Mis Solicitudes
            </button>
            <button class="nav-link" id="nav-gest" onclick="cambiarVista('sec-gest', this)">
                <span class="material-icons-round">fact_check</span> Gestionar Solicitudes
            </button>
            <button class="nav-link" id="nav-users" onclick="cambiarVista('sec-users', this)">
                <span class="material-icons-round">people</span> Usuarios
            </button>
        </nav>
        
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
            <p id="curr-name" style="font-weight: 700; font-size: 13px;"></p>
            <button onclick="location.reload()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:10px; margin-top: 10px;">CERRAR SESIÓN</button>
        </div>
    </aside>

    <main class="main" id="main">
        <section id="sec-dash" class="section">
            <h2>Panel Principal</h2>
            <div class="grid-3">
                <div class="card"><label>Total Solicitudes</label><h1 id="count-total">0</h1></div>
                <div class="card"><label>Pendientes</label><h1 id="count-pend" style="color: var(--warning);">0</h1></div>
                <div class="card"><label>Suministros Bajo Stock</label><h1 id="count-stock" style="color: var(--danger);">0</h1></div>
            </div>
        </section>

        <section id="sec-stock" class="section">
            <h2>Inventario de Suministros</h2>
            <div class="card" style="padding:0">
                <table id="table-stock">
                    <thead><tr><th>Suministro</th><th>Categoría</th><th>Cantidad</th><th>Estado</th></tr></thead>
                    <tbody id="tb-stock"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-crear" class="section">
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <h2>Nueva Solicitud de Suministros</h2>
                <label>Seleccionar Suministro</label>
                <select id="sol-item"></select>
                <label>Cantidad Solicitada</label>
                <input type="number" id="sol-cant" value="1" min="1">
                <label>Justificación / Comentarios</label>
                <textarea id="sol-coment" rows="3"></textarea>
                <button class="btn btn-primary" id="btnEnviar" style="width:100%">ENVIAR PEDIDO</button>
            </div>
        </section>

        <section id="sec-hist" class="section">
            <h2>Mis Solicitudes</h2>
            <div class="card" style="padding:0">
                <table>
                    <thead><tr><th>Fecha</th><th>Suministro</th><th>Cant.</th><th>Estado</th></tr></thead>
                    <tbody id="tb-hist"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-gest" class="section">
            <h2>Bandeja de Aprobación (Admin)</h2>
            <div class="card" style="padding:0">
                <table>
                    <thead><tr><th>Usuario</th><th>Suministro</th><th>Cant.</th><th>Acción</th></tr></thead>
                    <tbody id="tb-gest"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-users" class="section">
            <div class="card">
                <h2>Administración de Usuarios</h2>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 20px;">Gestiona los accesos del personal.</p>
                <div id="user-list"></div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, query, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // GESTIÓN DE VARIABLES DE ENTORNO SEGURA
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "demo-key", authDomain: "demo.firebaseapp.com", projectId: "demo-project", storageBucket: "demo.appspot.com", messagingSenderId: "000", appId: "000"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sgc-platinum-v1';

        let currentUser = null;

        // 1. AUTENTICACIÓN INICIAL (Regla 3)
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.warn("Auth Fallback");
            } finally {
                document.getElementById('auth-loading').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            }
        };
        initAuth();

        // 2. SISTEMA DE VISTAS
        window.cambiarVista = (id, btn) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(btn) btn.classList.add('active');
        };

        // 3. LOGIN Y ROLES
        document.getElementById('btnLogin').onclick = async () => {
            const u = document.getElementById('login-user').value.toLowerCase().trim();
            const p = document.getElementById('login-pass').value;

            // Admin por defecto
            if(u === 'admin' && p === '1130') {
                currentUser = { nombre: "Administrador Maestro", usuario: "admin", rol: "admin" };
                setupUI(currentUser);
                return;
            }

            // Buscar en DB
            const qUsers = query(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios'));
            const snap = await getDocs(qUsers);
            let found = null;
            snap.forEach(d => { if(d.data().usuario === u && d.data().pass === p) found = d.data(); });

            if(found) {
                currentUser = found;
                setupUI(currentUser);
            } else {
                alert("Usuario o contraseña incorrectos.");
            }
        };

        function setupUI(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main').style.display = 'block';
            document.getElementById('curr-name').innerText = user.nombre;

            if(user.rol === 'admin') {
                document.getElementById('nav-gest').classList.add('visible');
                document.getElementById('nav-users').classList.add('visible');
            }

            syncData();
        }

        function syncData() {
            const ref = (c) => collection(db, 'artifacts', appId, 'public', 'data', c);

            // Escuchar Solicitudes
            onSnapshot(ref("Solicitudes"), s => {
                const tbHist = document.getElementById('tb-hist');
                const tbGest = document.getElementById('tb-gest');
                tbHist.innerHTML = ""; tbGest.innerHTML = "";
                let counts = { t:0, p:0 };

                s.forEach(d => {
                    const sol = d.data();
                    counts.t++;
                    if(sol.estado === 'Pendiente') counts.p++;

                    const row = `<tr><td>${new Date(sol.fecha).toLocaleDateString()}</td><td>${sol.suministro}</td><td>${sol.cantidad}</td><td>${sol.estado}</td></tr>`;
                    
                    if(sol.user_id === currentUser.usuario) tbHist.innerHTML += row;

                    if(currentUser.rol === 'admin' && sol.estado === 'Pendiente') {
                        tbGest.innerHTML += `<tr><td>${sol.user_id}</td><td>${sol.suministro}</td><td>${sol.cantidad}</td><td>
                            <button class="btn-primary" onclick="window.gestionar('${d.id}', 'Aprobado')">Aprobar</button>
                        </td></tr>`;
                    }
                });
                document.getElementById('count-total').innerText = counts.t;
                document.getElementById('count-pend').innerText = counts.p;
            });

            // Cargar Inventario
            const items = ["Papel A4", "Tóner Negro", "Bolígrafos Blue", "Carpetas", "Grapas"];
            const sel = document.getElementById('sol-item');
            sel.innerHTML = items.map(i => `<option value="${i}">${i}</option>`).join('');
            
            const tbStock = document.getElementById('tb-stock');
            tbStock.innerHTML = items.map(i => `<tr><td>${i}</td><td>Oficina</td><td>25</td><td><span style="color:green">Disponible</span></td></tr>`).join('');
        }

        // 4. ACCIONES DE BASE DE DATOS
        document.getElementById('btnEnviar').onclick = async () => {
            const data = {
                suministro: document.getElementById('sol-item').value,
                cantidad: document.getElementById('sol-cant').value,
                comentario: document.getElementById('sol-coment').value,
                user_id: currentUser.usuario,
                fecha: new Date().toISOString(),
                estado: "Pendiente"
            };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'Solicitudes'), data);
            alert("Solicitud enviada");
            cambiarVista('sec-hist', document.getElementById('nav-hist'));
        };

        window.gestionar = async (id, estado) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Solicitudes', id), { estado });
            alert("Estado actualizado");
        };

    </script>
</body>
</html>
