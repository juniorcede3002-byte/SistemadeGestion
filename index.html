<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de GestiÃ³n Documental | FCI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#0a2540;color:#fff;padding:15px}
.hidden{display:none}
.container{display:flex}
aside{width:240px;background:#111;color:#fff;height:100vh}
aside button{width:100%;padding:15px;border:none;background:none;color:#fff;text-align:left;cursor:pointer}
aside button:hover{background:#333}
main{flex:1;padding:20px}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:20px}
input,select,textarea,button{width:100%;padding:8px;margin-top:5px}
button{background:#0a2540;color:#fff;border:none;border-radius:4px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px}
th{background:#eee}
.chat{border:1px solid #ccc;padding:10px;height:150px;overflow:auto}
.badge{padding:5px 10px;border-radius:20px;background:#ccc}
</style>
</head>

<body>

<header>
<h2>Sistema de GestiÃ³n Documental - FCI</h2>
</header>

<!-- LOGIN -->
<div id="login" class="card">
<h3>Ingreso al Sistema</h3>
<input id="loginUser" placeholder="Usuario">
<input id="loginPass" type="password" placeholder="ContraseÃ±a">
<button onclick="login()">Ingresar</button>
</div>

<!-- APP -->
<div id="app" class="container hidden">

<aside>
<button onclick="showTab('dashboard')">ðŸ“Š Dashboard</button>
<button onclick="showTab('crear')">âž• Crear Solicitud</button>
<button onclick="showTab('solicitudes')">ðŸ“„ Solicitudes</button>
<button onclick="showTab('usuarios')">ðŸ‘¤ Usuarios</button>
</aside>

<main>

<!-- DASHBOARD -->
<div id="dashboard" class="tab">
<div class="card">
<h3>EstadÃ­sticas Generales</h3>
<canvas id="chartEstados"></canvas>
</div>
</div>

<!-- CREAR SOLICITUD -->
<div id="crear" class="tab hidden">
<div class="card">
<h3>Nueva Solicitud</h3>

<input id="sol-nombre" placeholder="Nombre del documento">
<select id="sol-accion">
<option>CreaciÃ³n</option>
<option>ModificaciÃ³n</option>
<option>InactivaciÃ³n</option>
</select>

<select id="sol-tipo">
<option>GuÃ­a</option>
<option>Manual</option>
<option>Instructivo</option>
<option>Procedimiento</option>
<option>Formato</option>
</select>

<input id="sol-dep" placeholder="Departamento">
<input id="sol-ger" placeholder="Gerencia">
<input type="file" id="sol-file">
<textarea id="sol-motivo" placeholder="Motivo"></textarea>

<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>
</div>

<!-- SOLICITUDES -->
<div id="solicitudes" class="tab hidden">
<div class="card">
<h3>Solicitudes</h3>
<table>
<thead>
<tr>
<th>ID</th><th>Documento</th><th>Estado</th>
</tr>
</thead>
<tbody id="tablaSolicitudes"></tbody>
</table>
</div>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="tab hidden">
<div class="card">
<h3>GestiÃ³n de Usuarios</h3>
<input id="u-nombre" placeholder="Nombre">
<input id="u-user" placeholder="Usuario">
<input id="u-pass" placeholder="ContraseÃ±a">
<select id="u-rol">
<option>Admin</option>
<option>Usuario</option>
<option>Gerente</option>
</select>
<button onclick="crearUsuario()">Crear Usuario</button>

<table>
<thead><tr><th>Usuario</th><th>Rol</th></tr></thead>
<tbody id="tablaUsuarios"></tbody>
</table>
</div>
</div>

</main>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, query } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.appspot.com",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// CLOUDINARY
const CLOUD_NAME="df79cjklp";
const UPLOAD_PRESET="fci_documentos";

async function subirArchivo(file){
  const fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset",UPLOAD_PRESET);
  const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`,{method:"POST",body:fd});
  const d=await r.json();
  return d.secure_url;
}

// LOGIN SIMPLE
window.login = async ()=>{
  const u=loginUser.value;
  const p=loginPass.value;
  const snap=await getDocs(collection(db,"Usuarios"));
  snap.forEach(doc=>{
    if(doc.data().usuario===u && doc.data().pass===p){
      login.classList.add("hidden");
      appDiv.classList.remove("hidden");
      cargarTodo();
    }
  });
};

// CREAR SOLICITUD
window.crearSolicitud=async()=>{
  let url="";
  if(sol-file.files[0]) url=await subirArchivo(sol-file.files[0]);

  await addDoc(collection(db,"Solicitudes"),{
    id:"FCI-SOL-"+Math.floor(1000+Math.random()*9000),
    nombre:sol-nombre.value,
    estado:"Pendiente",
    fecha:new Date(),
    archivo:url
  });
  alert("Solicitud creada");
  cargarSolicitudes();
};

// CARGAR SOLICITUDES + CHART
async function cargarSolicitudes(){
  tablaSolicitudes.innerHTML="";
  let estados={Pendiente:0,Consulta:0,ReuniÃ³n:0,Aprobado:0};
  const snap=await getDocs(collection(db,"Solicitudes"));
  snap.forEach(d=>{
    estados[d.data().estado]=(estados[d.data().estado]||0)+1;
    tablaSolicitudes.innerHTML+=`<tr>
    <td>${d.data().id}</td>
    <td>${d.data().nombre}</td>
    <td><span class="badge">${d.data().estado}</span></td>
    </tr>`;
  });
  renderChart(estados);
}

function renderChart(est){
  new Chart(document.getElementById("chartEstados"),{
    type:"bar",
    data:{
      labels:Object.keys(est),
      datasets:[{
        label:"Solicitudes",
        data:Object.values(est),
        backgroundColor:"#0a2540"
      }]
    }
  });
}

// USUARIOS
window.crearUsuario=async()=>{
  await addDoc(collection(db,"Usuarios"),{
    nombre:u-nombre.value,
    usuario:u-user.value,
    pass:u-pass.value,
    rol:u-rol.value
  });
  cargarUsuarios();
};

async function cargarUsuarios(){
  tablaUsuarios.innerHTML="";
  const snap=await getDocs(collection(db,"Usuarios"));
  snap.forEach(d=>{
    tablaUsuarios.innerHTML+=`<tr><td>${d.data().usuario}</td><td>${d.data().rol}</td></tr>`;
  });
}

window.showTab=(t)=>{
  document.querySelectorAll(".tab").forEach(e=>e.classList.add("hidden"));
  document.getElementById(t).classList.remove("hidden");
};

function cargarTodo(){
  cargarSolicitudes();
  cargarUsuarios();
}

const appDiv=document.getElementById("app");
</script>

</body>
</html>