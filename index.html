<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | GestiÃ³n Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;margin:0}
header{background:#111827;color:#fff;padding:15px}
.card{background:#fff;padding:15px;margin:15px;border-radius:8px}
input,select,textarea,button{width:100%;margin-top:8px;padding:8px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:6px}
.hidden{display:none}
.badge{padding:4px 8px;border-radius:5px;background:#ddd}
</style>
</head>

<body>

<header>
<h2>ðŸ“„ FCI â€“ Sistema de GestiÃ³n Documental</h2>
</header>

<section class="card">
<h3>ðŸ‘¤ Usuario activo</h3>
<p><b>Usuario:</b> <span id="uNombre"></span></p>
<p><b>Correo:</b> <span id="uCorreo"></span></p>
<p><b>Rol:</b> <span id="uRol"></span></p>
</section>

<!-- CREAR SOLICITUD -->
<section class="card">
<h3>âž• Nueva Solicitud</h3>

<select id="tipoAccion">
<option>CreaciÃ³n</option>
<option>ModificaciÃ³n</option>
<option>Consulta</option>
<option>Solicitar reuniÃ³n</option>
</select>

<input id="nombreDocumento" placeholder="Nombre del documento">
<textarea id="motivo" placeholder="Motivo"></textarea>

<input type="date" id="fechaReunion" placeholder="Fecha reuniÃ³n (si aplica)">
<input type="file" id="archivo">

<button onclick="crearSolicitud()">Enviar Solicitud</button>
</section>

<!-- SOLICITUDES -->
<section class="card">
<h3>ðŸ“‹ Solicitudes</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>Documento</th>
<th>Estado</th>
<th>Solicitante</th>
<th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tablaSolicitudes"></tbody>
</table>
</section>

<!-- MODAL DETALLE -->
<section id="detalle" class="card hidden"></section>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d"
});
const db = firebase.firestore();

// ================= EMAILJS =================
emailjs.init("2jVnfkJKKG0bpKN-U");

// ================= USUARIO ACTIVO (CAMBIA AQUÃ) =================
const usuarioActivo = {
  usuario: "Admin",
  correo: "admin@fci.com",
  rol: "admin"
};

document.getElementById("uNombre").textContent = usuarioActivo.usuario;
document.getElementById("uCorreo").textContent = usuarioActivo.correo;
document.getElementById("uRol").textContent = usuarioActivo.rol;

// ================= CONTADOR =================
async function generarID(){
  const ref = db.collection("counters").doc("solicitudes");
  return db.runTransaction(async t=>{
    const d = await t.get(ref);
    let n = (d.exists ? d.data().valor : 0) + 1;
    t.set(ref,{valor:n});
    return "FCI-SOL-" + String(n).padStart(4,"0");
  });
}

// ================= CLOUDINARY =================
async function subirArchivo(file){
  if(!file) return "";
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", "fci_documentos");

  const res = await fetch(
    "https://api.cloudinary.com/v1_1/df79cjklp/auto/upload",
    {method:"POST", body:form}
  );

  if(!res.ok) return "";
  const data = await res.json();
  return data.secure_url || "";
}

// ================= CREAR SOLICITUD =================
async function crearSolicitud(){
  const id = await generarID();
  const archivo = document.getElementById("archivo").files[0];
  const url = await subirArchivo(archivo);

  await db.collection("solicitudes").add({
    idSolicitud: id,
    tipoAccion: tipoAccion.value,
    documento: nombreDocumento.value,
    motivo: motivo.value,
    fechaReunion: fechaReunion.value || "",
    archivo: url,
    estado: "Pendiente",
    solicitante: {
      usuario: usuarioActivo.usuario,
      correo: usuarioActivo.correo
    },
    fecha: firebase.firestore.FieldValue.serverTimestamp()
  });

  cargarSolicitudes();
}

// ================= LISTAR =================
async function cargarSolicitudes(){
  tablaSolicitudes.innerHTML="";
  const snap = await db.collection("solicitudes").orderBy("fecha","desc").get();

  snap.forEach(doc=>{
    const s = doc.data();
    tablaSolicitudes.innerHTML += `
      <tr>
        <td>${s.idSolicitud}</td>
        <td>${s.documento}</td>
        <td><span class="badge">${s.estado}</span></td>
        <td>${s.solicitante.usuario}</td>
        <td><button onclick="verDetalle('${doc.id}')">Ver</button></td>
      </tr>`;
  });
}

// ================= DETALLE =================
async function verDetalle(id){
  const d = await db.collection("solicitudes").doc(id).get();
  const s = d.data();

  detalle.classList.remove("hidden");
  detalle.innerHTML = `
    <h3>ðŸ“„ ${s.idSolicitud}</h3>
    <p><b>Documento:</b> ${s.documento}</p>
    <p><b>Motivo:</b> ${s.motivo}</p>
    <p><b>Solicitante:</b> ${s.solicitante.usuario} (${s.solicitante.correo})</p>
    <p><b>Estado:</b> ${s.estado}</p>

    ${usuarioActivo.rol==="admin" ? `
    <select id="nuevoEstado">
      <option>Pendiente</option>
      <option>Consulta</option>
      <option>Aprobado</option>
      <option>Verificado</option>
      <option>Finalizado</option>
    </select>
    <button onclick="cambiarEstado('${id}')">Actualizar Estado</button>
    ` : ""}
  `;
}

async function cambiarEstado(id){
  await db.collection("solicitudes").doc(id).update({
    estado: document.getElementById("nuevoEstado").value
  });
  cargarSolicitudes();
  detalle.classList.add("hidden");
}

// ================= INIT =================
cargarSolicitudes();
</script>
</body>
</html>