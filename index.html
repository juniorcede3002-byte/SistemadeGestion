<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Gestión Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
nav{background:#1f2937;color:#fff;padding:10px;display:flex;gap:10px}
nav button{padding:6px 12px}
.card{background:#fff;margin:10px;padding:15px;border-radius:8px}
.hidden{display:none}
input,select,textarea,button{padding:8px;margin:5px;width:100%}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}
.estado{padding:4px 6px;border-radius:4px;font-size:12px}
.pendiente{background:#fde047}
.finalizado{background:#4ade80}
.rechazado{background:#f87171}
</style>
</head>

<body>

<nav>
<strong>Dashboard Admin – Gestión Documental</strong>
<button onclick="vista('solicitudes')">Solicitudes</button>
<button onclick="vista('usuarios')">Usuarios</button>
<button onclick="vista('nuevaSolicitud')">Nueva Solicitud</button>
</nav>

<!-- SOLICITUDES -->
<div id="solicitudes" class="card">
<h3>Solicitudes</h3>
<table>
<thead>
<tr>
<th>Documento</th>
<th>Tipo</th>
<th>Acción</th>
<th>Estado</th>
<th>Archivo</th>
</tr>
</thead>
<tbody id="listaSolicitudes"></tbody>
</table>
</div>

<!-- NUEVA SOLICITUD -->
<div id="nuevaSolicitud" class="card hidden">
<h3>Nueva Solicitud</h3>

<input id="docNombre" placeholder="Nombre del documento">
<select id="docTipo">
<option>Procedimiento</option>
<option>Guía</option>
<option>Instructivo</option>
<option>Manual</option>
<option>Formato</option>
</select>

<select id="docAccion">
<option>Creación</option>
<option>Modificación</option>
<option>Inactivación</option>
</select>

<input id="docGerencia" placeholder="Gerencia">
<input id="docDepartamento" placeholder="Departamento">
<textarea id="docMotivo" placeholder="Motivo"></textarea>

<select id="docEstado">
<option>Pendiente</option>
<option>Solicitud de reunión</option>
<option>Consulta</option>
<option>3 firmas</option>
<option>Aprobación gerente</option>
<option>Finalizado</option>
<option>Rechazado</option>
</select>

<input type="file" id="docArchivo">

<button onclick="guardarSolicitud()">Guardar Solicitud</button>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="card hidden">
<h3>Usuarios</h3>

<input id="uUsuario" placeholder="Usuario">
<input id="uPassword" placeholder="Contraseña">
<input id="uCorreo" placeholder="Correo">
<select id="uRol">
<option>usuario</option>
<option>gerente</option>
<option>admin</option>
</select>
<input id="uGerencia" placeholder="Gerencia">
<input id="uDepartamento" placeholder="Departamento">
<button onclick="crearUsuario()">Crear Usuario</button>

<table>
<thead>
<tr>
<th>Usuario</th>
<th>Rol</th>
<th>Gerencia</th>
</tr>
</thead>
<tbody id="listaUsuarios"></tbody>
</table>
</div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d"
});
const db = firebase.firestore();

// ================= CLOUDINARY =================
const CLOUD_URL = "https://api.cloudinary.com/v1_1/df79cjklp/auto/upload";
const CLOUD_PRESET = "fci_documentos";

// ================= VISTAS =================
function vista(id){
  ["solicitudes","usuarios","nuevaSolicitud"].forEach(v=>{
    document.getElementById(v).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

// ================= SOLICITUDES =================
async function guardarSolicitud(){
  let archivo = "";
  const file = docArchivo.files[0];
  if(file){
    const fd = new FormData();
    fd.append("file",file);
    fd.append("upload_preset",CLOUD_PRESET);
    const r = await fetch(CLOUD_URL,{method:"POST",body:fd});
    archivo = (await r.json()).secure_url;
  }

  await db.collection("solicitudes").add({
    nombre:docNombre.value,
    tipo:docTipo.value,
    accion:docAccion.value,
    gerencia:docGerencia.value,
    departamento:docDepartamento.value,
    motivo:docMotivo.value,
    estado:docEstado.value,
    archivo,
    fecha:new Date()
  });

  vista("solicitudes");
  cargarSolicitudes();
}

async function cargarSolicitudes(){
  listaSolicitudes.innerHTML="";
  const s = await db.collection("solicitudes").orderBy("fecha","desc").get();
  s.forEach(d=>{
    const x=d.data();
    listaSolicitudes.innerHTML+=`
    <tr>
      <td>${x.nombre}</td>
      <td>${x.tipo}</td>
      <td>${x.accion}</td>
      <td><span class="estado ${x.estado.toLowerCase().replace(/ /g,'')}">${x.estado}</span></td>
      <td>${x.archivo?`<a href="${x.archivo}" target="_blank">Ver</a>`:""}</td>
    </tr>`;
  });
}

// ================= USUARIOS =================
async function crearUsuario(){
  await db.collection("usuarios").add({
    usuario:uUsuario.value,
    password:uPassword.value,
    correo:uCorreo.value,
    rol:uRol.value,
    gerencia:uGerencia.value,
    departamento:uDepartamento.value,
    activo:true
  });
  cargarUsuarios();
}

async function cargarUsuarios(){
  listaUsuarios.innerHTML="";
  const u = await db.collection("usuarios").get();
  u.forEach(d=>{
    const x=d.data();
    listaUsuarios.innerHTML+=`
    <tr>
      <td>${x.usuario}</td>
      <td>${x.rol}</td>
      <td>${x.gerencia}</td>
    </tr>`;
  });
}

// ================= INIT =================
cargarSolicitudes();
cargarUsuarios();
</script>

</body>
</html>