<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>FCI | Dashboard de Gesti贸n Documental</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e293b;
            --bg: #f8fafc;
            --text: #334155;
            --accent: #3b82f6;
            --white: #ffffff;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--secondary);
            height: 100vh;
            color: white;
            position: fixed;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #334155;
        }

        .nav-menu {
            flex-grow: 1;
            padding: 20px 0;
        }

        .nav-item {
            padding: 12px 25px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: 0.3s;
            color: #94a3b8;
        }

        .nav-item:hover, .nav-item.active {
            background: #334155;
            color: white;
            border-left: 4px solid var(--accent);
        }

        .nav-item i { margin-right: 15px; }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: 260px;
            width: calc(100% - 260px);
            padding: 30px;
        }

        .card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        h2 { margin-top: 0; font-weight: 600; color: var(--secondary); font-size: 1.5rem; }

        /* --- FORMULARIOS --- */
        .grid-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        input:focus { border-color: var(--primary); }

        button {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover { background: #1d4ed8; transform: translateY(-1px); }

        /* --- TABLAS --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            text-align: left;
            background: #f1f5f9;
            padding: 12px;
            font-size: 13px;
            text-transform: uppercase;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
        }

        .status-pill {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            background: #dcfce7;
            color: #166534;
        }

        .hidden { display: none; }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="sidebar-header">FCI SYSTEM</div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="mostrarSeccion('solicitudesSection')"><i class="fas fa-file-alt"></i> Solicitudes</div>
            <div class="nav-item" onclick="mostrarSeccion('nuevaSolicitudSection')"><i class="fas fa-plus-circle"></i> Nueva Solicitud</div>
            <div class="nav-item" onclick="mostrarSeccion('usuariosSection')"><i class="fas fa-users"></i> Usuarios</div>
            <div class="nav-item" onclick="mostrarSeccion('configuracionSection')"><i class="fas fa-cog"></i> Estructura</div>
        </div>
    </div>

    <div class="main-content">
        
        <div id="solicitudesSection" class="section">
            <div class="card">
                <h2> Panel de Solicitudes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>C贸digo</th>
                            <th>Documento</th>
                            <th>Gerencia</th>
                            <th>Estado</th>
                            <th>Acci贸n</th>
                        </tr>
                    </thead>
                    <tbody id="tablaSolicitudes"></tbody>
                </table>
            </div>

            <div id="detalleBox" class="card hidden">
                <h2> Detalle de Solicitud: <span id="det_codigo"></span></h2>
                <div class="grid-form">
                    <p><b>Nombre:</b> <span id="det_nombre"></span></p>
                    <p><b>Tipo:</b> <span id="det_tipo"></span></p>
                    <p><b>Acci贸n:</b> <span id="det_accion"></span></p>
                    <p><b>Estado:</b> <span id="det_estado" class="status-pill"></span></p>
                </div>
                
                <div id="historialBox" style="margin: 20px 0; max-height: 200px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 8px;"></div>

                <h3>Adjuntos</h3>
                <div id="adjuntosBox" style="margin-bottom: 15px;"></div>
                <div class="grid-form">
                    <input type="file" id="archivoAdjunto">
                    <button onclick="subirDocumento()"> Subir a Cloudinary</button>
                </div>

                <hr>
                <h3>Actualizar Estado</h3>
                <div class="grid-form">
                    <select id="estadoNuevo">
                        <option value="">-- Seleccionar Nuevo Estado --</option>
                        <option>Pendiente</option>
                        <option>Solicitud de reuni贸n</option>
                        <option>Consulta</option>
                        <option>Firma documentado</option>
                        <option>Firma verificado</option>
                        <option>Aprobaci贸n gerente</option>
                        <option>Finalizado</option>
                    </select>
                    <input type="text" id="estadoComentario" placeholder="Agregar un comentario...">
                    <button onclick="cambiarEstado()">Guardar Cambio</button>
                </div>
            </div>
        </div>

        <div id="nuevaSolicitudSection" class="section hidden">
            <div class="card">
                <h2> Crear Nueva Solicitud</h2>
                <div class="grid-form">
                    <input id="s_nombre" placeholder="Nombre del documento">
                    <select id="s_tipo">
                        <option>Procedimiento</option>
                        <option>Instructivo</option>
                        <option>Formato</option>
                    </select>
                    <select id="s_accion" onchange="accionChange()">
                        <option value="crear">Crear</option>
                        <option value="modificar">Modificar</option>
                        <option value="inactivar">Inactivar</option>
                    </select>
                </div>
                <div id="modBox" class="grid-form hidden">
                    <input id="s_version" placeholder="ltima versi贸n">
                    <input id="s_codigo" placeholder="C贸digo anterior">
                </div>
                <div class="grid-form">
                    <select id="s_gerencia_select"></select>
                    <select id="s_departamento_select"></select>
                </div>
                <textarea id="s_motivo" placeholder="Motivo de la solicitud" rows="3"></textarea>
                <button onclick="crearSolicitud()"> Enviar Solicitud</button>
            </div>
        </div>

        <div id="usuariosSection" class="section hidden">
            <div class="card">
                <h2> Gesti贸n de Usuarios</h2>
                <div class="grid-form">
                    <input id="u_usuario" placeholder="Username">
                    <input id="u_pass" type="password" placeholder="Password">
                    <input id="u_correo" placeholder="Email">
                    <select id="u_rol">
                        <option>Usuario</option>
                        <option>Gerente</option>
                        <option>Admin</option>
                    </select>
                </div>
                <h4>Permisos</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                    <label><input type="checkbox" id="p_solicitar"> Crear Solicitudes</label>
                    <label><input type="checkbox" id="p_aprobar"> Aprobar</label>
                    <label><input type="checkbox" id="p_users"> Gestionar Staff</label>
                </div>
                <button onclick="crearUsuario()">Guardar Usuario</button>
                
                <h3 style="margin-top: 30px;">Listado de Personal</h3>
                <table>
                    <thead><tr><th>Usuario</th><th>Rol</th><th>Gerencia</th><th>Acci贸n</th></tr></thead>
                    <tbody id="usuariosTabla"></tbody>
                </table>
            </div>
        </div>

        <div id="configuracionSection" class="section hidden">
            <div class="grid-form">
                <div class="card">
                    <h2> Gerencias</h2>
                    <input id="g_nombre" placeholder="Nombre Gerencia">
                    <button onclick="crearGerencia()" style="width: 100%;">A帽adir</button>
                    <ul id="gerenciasLista"></ul>
                </div>
                <div class="card">
                    <h2> Departamentos</h2>
                    <input id="d_nombre" placeholder="Nombre Depto">
                    <button onclick="crearDepto()" style="width: 100%;">A帽adir</button>
                    <ul id="deptosLista"></ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        /* CONFIGURACIN FIREBASE */
        const firebaseConfig = {
            apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
            authDomain: "sistemadegestion-7400d.firebaseapp.com",
            projectId: "sistemadegestion-7400d",
            storageBucket: "sistemadegestion-7400d.firebasestorage.app",
            messagingSenderId: "709030283072",
            appId: "1:709030283072:web:5997837b36a448e9515ca5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        /* CONFIGURACIN CLOUDINARY */
        const cloudName = "df79cjklp";          
        const uploadPreset = "fci_documentos"; 

        let solicitudActual = null;

        /* NAVEGACIN */
        function mostrarSeccion(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        /* LGICA DE SOLICITUDES */
        function accionChange(){
            const accion = document.getElementById("s_accion").value;
            document.getElementById("modBox").classList.toggle("hidden", accion === "crear");
        }

        function generarCodigo(){ return "DOC-" + Date.now(); }

        function crearSolicitud(){
            const codigo = generarCodigo();
            const data = {
                codigo,
                nombre: s_nombre.value,
                tipo: s_tipo.value,
                accion: s_accion.value,
                gerencia: s_gerencia_select.value,
                departamento: s_departamento_select.value,
                motivo: s_motivo.value,
                estado: "Pendiente",
                fecha: new Date(),
                historial: [{ estado:"Pendiente", fecha:new Date(), comentario:"Solicitud creada" }],
                adjuntos: []
            };

            db.collection("solicitudes").doc(codigo).set(data).then(()=>{
                alert("Solicitud enviada con 茅xito");
                mostrarSeccion('solicitudesSection');
            });
        }

        function cargarSolicitudes(){
            db.collection("solicitudes").orderBy("fecha","desc").onSnapshot(snap=>{
                tablaSolicitudes.innerHTML="";
                snap.forEach(doc=>{
                    const d = doc.data();
                    tablaSolicitudes.innerHTML += `
                    <tr>
                        <td><b>${d.codigo}</b></td>
                        <td>${d.nombre}</td>
                        <td>${d.gerencia}</td>
                        <td><span class="status-pill">${d.estado}</span></td>
                        <td><button onclick="verDetalle('${d.codigo}')">Ver</button></td>
                    </tr>`;
                });
            });
        }

        function verDetalle(codigo){
            db.collection("solicitudes").doc(codigo).get().then(doc=>{
                if(!doc.exists) return;
                solicitudActual = codigo;
                const d = doc.data();
                document.getElementById("detalleBox").classList.remove("hidden");
                det_codigo.innerText = d.codigo;
                det_nombre.innerText = d.nombre;
                det_tipo.innerText = d.tipo;
                det_accion.innerText = d.accion;
                det_estado.innerText = d.estado;

                historialBox.innerHTML = d.historial.map(h => `
                    <div style="font-size:12px; margin-bottom:10px; border-bottom:1px solid #eee">
                        <b>${h.estado}</b> - ${new Date(h.fecha.seconds*1000).toLocaleString()}<br>
                        <span style="color:#666">${h.comentario || ''}</span>
                    </div>
                `).join('');

                adjuntosBox.innerHTML = (d.adjuntos || []).map(a => `
                    <a href="${a.url}" target="_blank" style="display:block; color:var(--primary); margin:5px 0;">
                        <i class="fas fa-paperclip"></i> ${a.nombre}
                    </a>
                `).join('');
            });
        }

        /* INTEGRACIN CLOUDINARY */
        async function subirDocumento() {
            const file = document.getElementById("archivoAdjunto").files[0];
            if (!file || !solicitudActual) return alert("Selecciona un archivo primero");

            const btn = event.target;
            btn.innerText = "Subiendo...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", uploadPreset);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();
                
                await db.collection("solicitudes").doc(solicitudActual).update({
                    adjuntos: firebase.firestore.FieldValue.arrayUnion({
                        nombre: file.name,
                        url: data.secure_url
                    })
                });

                alert("Archivo subido y vinculado");
                verDetalle(solicitudActual);
            } catch (error) {
                console.error(error);
                alert("Error al subir");
            } finally {
                btn.innerText = " Subir a Cloudinary";
                btn.disabled = false;
            }
        }

        function cambiarEstado(){
            const nuevo = estadoNuevo.value;
            const comentario = estadoComentario.value;
            if(!solicitudActual || !nuevo) return;

            db.collection("solicitudes").doc(solicitudActual).update({
                estado: nuevo,
                historial: firebase.firestore.FieldValue.arrayUnion({
                    estado: nuevo,
                    comentario,
                    fecha: new Date()
                })
            }).then(() => {
                alert("Estado actualizado");
                verDetalle(solicitudActual);
            });
        }

        /* GESTIN DE ESTRUCTURA Y USUARIOS */
        function crearGerencia(){
            db.collection("gerencias").add({nombre:g_nombre.value}).then(cargarGerencias);
        }
        function cargarGerencias(){
            gerenciasLista.innerHTML = "";
            s_gerencia_select.innerHTML = "";
            db.collection("gerencias").get().then(q=>{
                q.forEach(d=>{
                    gerenciasLista.innerHTML+=`<li>${d.data().nombre}</li>`;
                    s_gerencia_select.innerHTML+=`<option>${d.data().nombre}</option>`;
                });
            });
        }

        function crearDepto(){
            db.collection("departamentos").add({nombre:d_nombre.value}).then(cargarDeptos);
        }
        function cargarDeptos(){
            deptosLista.innerHTML = "";
            s_departamento_select.innerHTML = "";
            db.collection("departamentos").get().then(q=>{
                q.forEach(d=>{
                    deptosLista.innerHTML+=`<li>${d.data().nombre}</li>`;
                    s_departamento_select.innerHTML+=`<option>${d.data().nombre}</option>`;
                });
            });
        }

        function crearUsuario(){
            const data={
                usuario: u_usuario.value,
                password: u_pass.value,
                correo: u_correo.value,
                rol: u_rol.value,
                permisos: {
                    solicitar: p_solicitar.checked,
                    aprobar: p_aprobar.checked,
                    users: p_users.checked
                }
            };
            db.collection("usuarios").doc(data.usuario).set(data).then(()=>{
                alert("Usuario Guardado");
                cargarUsuarios();
            });
        }

        function cargarUsuarios(){
            usuariosTabla.innerHTML="";
            db.collection("usuarios").get().then(q=>{
                q.forEach(d=>{
                    const u=d.data();
                    usuariosTabla.innerHTML+=`<tr><td>${u.usuario}</td><td>${u.rol}</td><td>Admin</td><td><button onclick="this.parentElement.parentElement.remove()">Borrar</button></td></tr>`;
                });
            });
        }

        // Inicializaci贸n
        cargarSolicitudes();
        cargarGerencias();
        cargarDeptos();
        cargarUsuarios();

    </script>
</body>
</html>
