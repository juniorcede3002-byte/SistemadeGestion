<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Gestión Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
.hidden{display:none}
input,select,textarea,button{padding:8px;margin:5px;width:100%}
button{cursor:pointer}
.card{background:#fff;padding:15px;margin:10px;border-radius:8px}
nav{background:#1f2937;color:#fff;padding:10px;display:flex;gap:10px}
nav button{width:auto}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:6px}
th{background:#eee}
.badge{padding:3px 6px;border-radius:4px;font-size:12px}
.estado-pendiente{background:#facc15}
.estado-finalizado{background:#4ade80}
.estado-rechazado{background:#f87171}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="card">
<h2>Ingreso al Sistema</h2>
<input id="loginUsuario" placeholder="Usuario">
<input id="loginPassword" type="password" placeholder="Contraseña">
<button onclick="login()">Ingresar</button>
<p id="loginError" style="color:red"></p>
</div>

<!-- DASHBOARD -->
<div id="app" class="hidden">

<nav>
<span id="userInfo"></span>
<button onclick="mostrar('solicitudes')">Solicitudes</button>
<button onclick="mostrar('usuarios')" id="btnUsuarios">Usuarios</button>
<button onclick="logout()">Salir</button>
</nav>

<!-- SOLICITUDES -->
<div id="solicitudes" class="card hidden">
<h3>Solicitudes</h3>

<button onclick="nuevaSolicitud()">Nueva Solicitud</button>

<table>
<thead>
<tr>
<th>Documento</th>
<th>Tipo</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaSolicitudes"></tbody>
</table>
</div>

<!-- NUEVA SOLICITUD -->
<div id="formSolicitud" class="card hidden">
<h3>Nueva Solicitud</h3>

<input id="docNombre" placeholder="Nombre del documento">
<select id="docTipo">
<option>Procedimiento</option>
<option>Guía</option>
<option>Instructivo</option>
<option>Manual</option>
<option>Formato</option>
</select>

<select id="docAccion">
<option>Creación</option>
<option>Modificación</option>
<option>Inactivación</option>
</select>

<input id="docGerencia" placeholder="Gerencia">
<input id="docDepartamento" placeholder="Departamento">
<textarea id="docMotivo" placeholder="Motivo"></textarea>

<input type="file" id="docArchivo">

<button onclick="guardarSolicitud()">Guardar</button>
<button onclick="mostrar('solicitudes')">Cancelar</button>
</div>

<!-- USUARIOS -->
<div id="usuarios" class="card hidden">
<h3>Gestión de Usuarios</h3>

<input id="uUsuario" placeholder="Usuario">
<input id="uPassword" placeholder="Contraseña">
<input id="uCorreo" placeholder="Correo">
<select id="uRol">
<option value="usuario">Usuario</option>
<option value="gerente">Gerente</option>
<option value="admin">Admin</option>
</select>
<input id="uGerencia" placeholder="Gerencia">
<input id="uDepartamento" placeholder="Departamento">

<button onclick="crearUsuario()">Crear Usuario</button>

<table>
<thead>
<tr>
<th>Usuario</th>
<th>Rol</th>
<th>Activo</th>
</tr>
</thead>
<tbody id="tablaUsuarios"></tbody>
</table>
</div>

</div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d"
});
const db = firebase.firestore();

// ================= CLOUDINARY =================
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/df79cjklp/auto/upload";
const CLOUDINARY_PRESET = "fci_documentos";

// ================= SESIÓN =================
let usuarioActual = null;

// ================= LOGIN =================
async function login(){
  const u = loginUsuario.value.trim();
  const p = loginPassword.value.trim();
  loginError.textContent = "";

  const q = await db.collection("usuarios")
    .where("usuario","==",u)
    .where("password","==",p)
    .where("activo","==",true)
    .get();

  if(q.empty){
    loginError.textContent="Credenciales inválidas";
    return;
  }

  usuarioActual = {id:q.docs[0].id,...q.docs[0].data()};
  login.classList.add("hidden");
  app.classList.remove("hidden");
  userInfo.textContent = usuarioActual.usuario+" ("+usuarioActual.rol+")";

  if(usuarioActual.rol!=="admin"){
    btnUsuarios.style.display="none";
  }

  cargarSolicitudes();
  if(usuarioActual.rol==="admin") cargarUsuarios();
}

// ================= LOGOUT =================
function logout(){
  location.reload();
}

// ================= VISTAS =================
function mostrar(id){
  ["solicitudes","usuarios","formSolicitud"].forEach(v=>{
    document.getElementById(v).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

// ================= SOLICITUDES =================
function nuevaSolicitud(){
  mostrar("formSolicitud");
}

async function guardarSolicitud(){
  let archivoURL = "";
  const file = docArchivo.files[0];
  if(file){
    const fd = new FormData();
    fd.append("file",file);
    fd.append("upload_preset",CLOUDINARY_PRESET);
    const r = await fetch(CLOUDINARY_URL,{method:"POST",body:fd});
    archivoURL = (await r.json()).secure_url;
  }

  await db.collection("solicitudes").add({
    nombre:docNombre.value,
    tipo:docTipo.value,
    accion:docAccion.value,
    gerencia:docGerencia.value,
    departamento:docDepartamento.value,
    motivo:docMotivo.value,
    archivo:archivoURL,
    estado:"Pendiente",
    creador:usuarioActual.usuario,
    rolCreador:usuarioActual.rol,
    fecha:new Date()
  });

  mostrar("solicitudes");
  cargarSolicitudes();
}

async function cargarSolicitudes(){
  tablaSolicitudes.innerHTML="";
  let q = db.collection("solicitudes");

  if(usuarioActual.rol==="usuario"){
    q = q.where("creador","==",usuarioActual.usuario);
  }
  if(usuarioActual.rol==="gerente"){
    q = q.where("gerencia","==",usuarioActual.gerencia);
  }

  const snap = await q.get();
  snap.forEach(d=>{
    const s=d.data();
    tablaSolicitudes.innerHTML+=`
      <tr>
        <td>${s.nombre}</td>
        <td>${s.tipo}</td>
        <td><span class="badge estado-${s.estado.toLowerCase()}">${s.estado}</span></td>
        <td>${s.archivo?`<a href="${s.archivo}" target="_blank">Ver</a>`:""}</td>
      </tr>`;
  });
}

// ================= USUARIOS =================
async function crearUsuario(){
  await db.collection("usuarios").add({
    usuario:uUsuario.value,
    password:uPassword.value,
    correo:uCorreo.value,
    rol:uRol.value,
    gerencia:uGerencia.value,
    departamento:uDepartamento.value,
    activo:true
  });
  cargarUsuarios();
}

async function cargarUsuarios(){
  tablaUsuarios.innerHTML="";
  const snap = await db.collection("usuarios").get();
  snap.forEach(d=>{
    const u=d.data();
    tablaUsuarios.innerHTML+=`
    <tr>
      <td>${u.usuario}</td>
      <td>${u.rol}</td>
      <td>${u.activo}</td>
    </tr>`;
  });
}
</script>

</body>
</html>