<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vendors | Sistema de Gesti√≥n</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0 }
header { background:#111; color:#fff; padding:15px }
section { padding:20px }
.card { background:#fff; padding:15px; margin-bottom:15px; border-radius:8px }
input, select, textarea, button {
  width:100%; padding:10px; margin-top:5px; margin-bottom:10px
}
button { cursor:pointer; background:#111; color:#fff; border:none }
.hidden { display:none }
.admin { border-left:5px solid #e53935 }
.user { border-left:5px solid #43a047 }
</style>
</head>

<body>

<header>
  <h2>Vendors ‚Äì Sistema de Gesti√≥n</h2>
</header>

<section id="login">
  <h3>Iniciar sesi√≥n</h3>
  <form onsubmit="login(event)">
    <input id="username" placeholder="Usuario" required>
    <input id="password" type="password" placeholder="Contrase√±a" required>
    <button>Entrar</button>
  </form>
</section>

<section id="panel" class="hidden"></section>

<script>
/* =====================================================
   üî• FIREBASE CONFIG (TU API ‚Äì NO SE ELIMINA NADA)
===================================================== */

// Tu configuraci√≥n original ADAPTADA a compat
firebase.initializeApp({
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
});

const db = firebase.firestore();

/* =====================================================
   üîê LOGIN INTERNO (SIN FIREBASE AUTH)
===================================================== */

let currentUser = null;

async function login(e){
  e.preventDefault();

  const user = username.value.trim();
  const pass = password.value.trim();

  const snap = await db.collection("users")
    .where("username","==",user)
    .where("password","==",pass)
    .get();

  if(snap.empty){
    alert("Credenciales incorrectas");
    return;
  }

  currentUser = { id: snap.docs[0].id, ...snap.docs[0].data() };
  document.getElementById("login").classList.add("hidden");
  loadPanel();
}

/* =====================================================
   üß† PANEL PRINCIPAL
===================================================== */

function loadPanel(){
  panel.classList.remove("hidden");
  panel.innerHTML = `
    <h3>Bienvenido, ${currentUser.name}</h3>
    <p><b>Rol:</b> ${currentUser.role}</p>

    ${currentUser.role === "admin" ? `
      <button onclick="showCreateUser()">Crear Usuario</button>
      <button onclick="loadOrders(true)">Ver Todos los Pedidos</button>
    ` : `
      <button onclick="createOrder()">Nueva Solicitud</button>
      <button onclick="loadOrders(false)">Mis Solicitudes</button>
    `}

    <div id="content"></div>
  `;
}

/* =====================================================
   üë§ ADMIN ‚Äì CREAR USUARIOS
===================================================== */

function showCreateUser(){
  content().innerHTML = `
    <h4>Crear Usuario</h4>
    <form onsubmit="createUser(event)">
      <input placeholder="Nombre" required>
      <input placeholder="Usuario" required>
      <input placeholder="Contrase√±a" required>
      <select>
        <option value="user">Usuario</option>
        <option value="admin">Admin</option>
      </select>
      <button>Crear</button>
    </form>
  `;
}

async function createUser(e){
  e.preventDefault();
  const f = e.target;

  await db.collection("users").add({
    name: f[0].value,
    username: f[1].value,
    password: f[2].value,
    role: f[3].value,
    createdAt: Date.now()
  });

  alert("Usuario creado correctamente");
  f.reset();
}

/* =====================================================
   üì¶ USUARIO ‚Äì CREAR SOLICITUD
===================================================== */

function createOrder(){
  content().innerHTML = `
    <h4>Nueva Solicitud</h4>
    <form onsubmit="saveOrder(event)">
      <input placeholder="Producto" required>
      <textarea placeholder="Descripci√≥n" required></textarea>
      <input type="number" placeholder="Precio" required>
      <button>Enviar Solicitud</button>
    </form>
  `;
}

async function saveOrder(e){
  e.preventDefault();
  const f = e.target;

  await db.collection("orders").add({
    userId: currentUser.id,
    product: f[0].value,
    description: f[1].value,
    price: Number(f[2].value),
    status: "pendiente",
    createdAt: Date.now()
  });

  alert("Solicitud enviada");
  f.reset();
}

/* =====================================================
   üìã PEDIDOS (ADMIN / USER)
===================================================== */

function loadOrders(isAdmin){
  let q = db.collection("orders");
  if(!isAdmin){
    q = q.where("userId","==",currentUser.id);
  }

  q.onSnapshot(snap=>{
    content().innerHTML = "<h4>Solicitudes</h4>";

    snap.forEach(doc=>{
      const o = doc.data();
      content().innerHTML += `
        <div class="card ${isAdmin?'admin':'user'}">
          <b>${o.product}</b>
          <p>${o.description}</p>
          <p><b>$${o.price}</b></p>
          <p>Estado: ${o.status}</p>

          ${!isAdmin ? `
            <input placeholder="URL comprobante" onchange="addReceipt('${doc.id}',this.value)">
          ` : `
            <select onchange="updateStatus('${doc.id}',this.value)">
              <option ${o.status==='pendiente'?'selected':''}>pendiente</option>
              <option ${o.status==='en revisi√≥n'?'selected':''}>en revisi√≥n</option>
              <option ${o.status==='aprobado'?'selected':''}>aprobado</option>
              <option ${o.status==='entregado'?'selected':''}>entregado</option>
            </select>
          `}
        </div>
      `;
    });
  });
}

function addReceipt(id,url){
  db.collection("orders").doc(id).update({
    receiptUrl: url,
    status: "en revisi√≥n"
  });
}

function updateStatus(id,status){
  db.collection("orders").doc(id).update({ status });
}

function content(){
  return document.getElementById("content");
}
</script>

</body>
</html>