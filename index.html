<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | GestiÃ³n Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;margin:0}
header{background:#111827;color:#fff;padding:15px;text-align:center}
.card{background:#fff;padding:15px;margin:15px;border-radius:8px}
input,select,textarea,button{width:100%;margin-top:8px;padding:8px;border-radius:4px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:6px;text-align:left}
.hidden{display:none}
h2,h3{margin:5px 0}
</style>
</head>
<body>

<header>
<h2>ðŸ“„ FCI â€“ Sistema de Solicitudes Documentales</h2>
</header>

<!-- LOGIN -->
<section id="login-section" class="card">
<h3>Login</h3>
<input id="loginUsuario" placeholder="Usuario">
<input id="loginPassword" placeholder="ContraseÃ±a" type="password">
<button onclick="login()">Ingresar</button>
<p id="login-error" style="color:red"></p>
</section>

<!-- PANEL PRINCIPAL -->
<section id="panel" class="card hidden">
<h3>Bienvenido <span id="nombreUsuario"></span> (<span id="rolUsuario"></span>)</h3>

<!-- Panel de Solicitud -->
<div class="card" id="solicitud-panel">
<h3>âž• Nueva Solicitud</h3>
<select id="tipoAccion">
<option>CreaciÃ³n</option>
<option>ModificaciÃ³n</option>
<option>InactivaciÃ³n</option>
</select>

<input id="nombreDocumento" placeholder="Nombre documento">
<select id="gerencia"></select>
<select id="departamento"></select>
<textarea id="motivo" placeholder="Motivo"></textarea>

<input id="codificacion" placeholder="CodificaciÃ³n actual">
<input id="ultimaVersion" placeholder="Ãšltima versiÃ³n">
<input type="date" id="fechaUltimaVersion">

<input type="file" id="archivo">
<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>

<!-- Tabla de Solicitudes -->
<div class="card">
<h3>ðŸ“‹ Solicitudes</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>Documento</th>
<th>Estado</th>
<th>Solicitante</th>
<th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<!-- PANEL ADMIN -->
<div class="card hidden" id="admin-panel">
<h3>âš™ Panel de AdministraciÃ³n</h3>

<!-- Usuarios -->
<div class="card">
<h4>Usuarios</h4>
<input id="nuevoUsuario" placeholder="Usuario">
<input id="nuevoCorreo" placeholder="Correo">
<input id="nuevaPassword" placeholder="ContraseÃ±a">
<select id="nuevoRol">
<option value="usuario">Usuario</option>
<option value="gerente">Gerente</option>
<option value="admin">Admin</option>
</select>
<select id="nuevoGerencia"></select>
<button onclick="crearUsuario()">Crear Usuario</button>
<div id="usuarios-lista"></div>
</div>

<!-- Gerencias -->
<div class="card">
<h4>Gerencias</h4>
<input id="nuevaGerenciaInput" placeholder="Nombre Gerencia">
<button onclick="crearGerencia()">Crear Gerencia</button>
<div id="gerencias-lista"></div>
</div>

<!-- Departamentos -->
<div class="card">
<h4>Departamentos</h4>
<input id="nuevoDepartamentoInput" placeholder="Nombre Departamento">
<button onclick="crearDepartamento()">Crear Departamento</button>
<div id="departamentos-lista"></div>
</div>

</div>

<script>
// ================= CONFIG FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// EmailJS
emailjs.init("2jVnfkJKKG0bpKN-U");

// ================= VARIABLES =================
let usuarioActual = null;

// ================= LOGIN =================
async function login(){
  const u = document.getElementById("loginUsuario").value;
  const p = document.getElementById("loginPassword").value;

  const snap = await db.collection("users").where("usuario","==",u).where("password","==",p).get();
  if(snap.empty){
    document.getElementById("login-error").innerText="Usuario o contraseÃ±a incorrecta";
    return;
  }
  const user = snap.docs[0].data();
  usuarioActual = user;

  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("panel").classList.remove("hidden");
  document.getElementById("nombreUsuario").innerText=user.usuario;
  document.getElementById("rolUsuario").innerText=user.rol;
  if(user.rol=="admin") document.getElementById("admin-panel").classList.remove("hidden");

  cargarGerenciasSelect();
  cargarDepartamentosSelect();
  cargarSolicitudes();
  if(user.rol=="admin") cargarUsuariosList();
  cargarGerenciasList();
  cargarDepartamentosList();
}

// ================= FUNCIONES SOLICITUD =================

// Generar ID Ãºnico
async function generarID(){
  const ref = db.collection("counters").doc("global");
  return db.runTransaction(async t=>{
    const d = await t.get(ref);
    let n = (d.exists ? d.data().solicitudes : 0) + 1;
    t.set(ref,{solicitudes:n},{merge:true});
    return "FCI-SOL-" + String(n).padStart(4,"0");
  });
}

// Subir archivo a Cloudinary
async function subirArchivo(file){
  if(!file) return "";
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", "fci_documentos");
  const res = await fetch("https://api.cloudinary.com/v1_1/df79cjklp/auto/upload",{method:"POST", body:form});
  const data = await res.json();
  return data.secure_url;
}

// Crear solicitud
async function crearSolicitud(){
  const id = await generarID();
  const archivoFile = document.getElementById("archivo").files[0];
  const url = await subirArchivo(archivoFile);

  const nuevaSolicitud = {
    idSolicitud: id,
    tipoAccion: document.getElementById("tipoAccion").value,
    nombreDocumento:document.getElementById("nombreDocumento").value,
    gerencia:document.getElementById("gerencia").value,
    departamento:document.getElementById("departamento").value,
    motivo:document.getElementById("motivo").value,
    codificacionActual:document.getElementById("codificacion").value,
    ultimaVersion:document.getElementById("ultimaVersion").value,
    fechaUltimaVersion:document.getElementById("fechaUltimaVersion").value,
    documento:url||"",
    estado:"pendiente",
    solicitante:{ usuario: usuarioActual.usuario, correo: usuarioActual.correo },
    fecha: firebase.firestore.FieldValue.serverTimestamp(),
    firmas:{documentado:null, verificado:null, codificado:null}
  };

  await db.collection("solicitudes").add(nuevaSolicitud);

  enviarCorreo(usuarioActual.correo,id,"Pendiente","Tu solicitud fue registrada correctamente.");
  alert("Solicitud creada: "+id);
  cargarSolicitudes();
}

// Cargar solicitudes
async function cargarSolicitudes(){
  const tabla = document.getElementById("tabla");
  tabla.innerHTML="";
  const snap = await db.collection("solicitudes").orderBy("fecha","desc").get();
  snap.forEach(d=>{
    const s = d.data();
    tabla.innerHTML+=`
      <tr>
        <td>${s.idSolicitud}</td>
        <td>${s.nombreDocumento}</td>
        <td>${s.estado}</td>
        <td>${s.solicitante.usuario} (${s.solicitante.correo})</td>
        <td><button onclick='verSolicitud("${d.id}")'>Ver / Cambiar Estado</button></td>
      </tr>`;
  });
}

// Ver detalles y cambiar estado
async function verSolicitud(id){
  const docSnap = await db.collection("solicitudes").doc(id).get();
  if(!docSnap.exists) return alert("Solicitud no encontrada");
  const s = docSnap.data();
  let estadoNuevo = prompt(`Solicitud: ${s.idSolicitud}\nEstado actual: ${s.estado}\nIngresar nuevo estado:\nPendiente, Consulta, Solicitar ReuniÃ³n, Aprobado Sistema de GestiÃ³n, Solicitar AprobaciÃ³n Gerente, Finalizado`);
  if(!estadoNuevo) return;
  s.estado = estadoNuevo;
  if(estadoNuevo=="Consulta" || estadoNuevo=="Solicitar ReuniÃ³n"){
    s.motivo = prompt("Ingrese motivo adicional:") || s.motivo;
  }
  if(estadoNuevo=="Aprobado Sistema de GestiÃ³n"){
    s.firmas.documentado = prompt("Nombre Documentado:")||null;
    s.firmas.verificado = prompt("Nombre Verificado:")||null;
    s.firmas.codificado = prompt("Nombre Codificado:")||null;
  }
  await db.collection("solicitudes").doc(id).set(s);
  cargarSolicitudes();
}

// ================= FUNCIONES ADMIN =================

// Crear usuario
async function crearUsuario(){
  const u = document.getElementById("nuevoUsuario").value;
  const c = document.getElementById("nuevoCorreo").value;
  const p = document.getElementById("nuevaPassword").value;
  const r = document.getElementById("nuevoRol").value;
  const g = document.getElementById("nuevoGerencia").value;
  if(!u||!c||!p||!r||!g) return alert("Completa todos los campos");
  await db.collection("users").doc(u).set({usuario:u,correo:c,password:p,rol:r,gerencia:g});
  alert("Usuario creado");
  cargarUsuariosList();
}

// Cargar usuarios
async function cargarUsuariosList(){
  const snap = await db.collection("users").get();
  let html="";
  snap.forEach(d=>{
    const u = d.data();
    html+=`<p>${u.usuario} (${u.correo}) - Rol: ${u.rol} - Gerencia: ${u.gerencia} <button onclick="eliminarUsuario('${d.id}')">Eliminar</button></p>`;
  });
  document.getElementById("usuarios-lista").innerHTML=html;
}

// Eliminar usuario
async function eliminarUsuario(id){
  await db.collection("users").doc(id).delete();
  cargarUsuariosList();
}

// Crear gerencia
async function crearGerencia(){
  const g = document.getElementById("nuevaGerenciaInput").value;
  if(!g) return alert("Ingresa nombre de gerencia");
  await db.collection("gerencias").add({nombre:g});
  document.getElementById("nuevaGerenciaInput").value="";
  cargarGerenciasList();
  cargarGerenciasSelect();
}

// Cargar gerencias
async function cargarGerenciasList(){
  const snap = await db.collection("gerencias").get();
  let html="";
  snap.forEach(d=>{
    const g = d.data();
    html+=`<p>${g.nombre} <button onclick="eliminarGerencia('${d.id}')">Eliminar</button></p>`;
  });
  document.getElementById("gerencias-lista").innerHTML=html;
}

// Eliminar gerencia
async function eliminarGerencia(id){
  await db.collection("gerencias").doc(id).delete();
  cargarGerenciasList();
  cargarGerenciasSelect();
}

// Crear departamento
async function crearDepartamento(){
  const d = document.getElementById("nuevoDepartamentoInput").value;
  if(!d) return alert("Ingresa nombre de departamento");
  await db.collection("departamentos").add({nombre:d});
  document.getElementById("nuevoDepartamentoInput").value="";
  cargarDepartamentosList();
  cargarDepartamentosSelect();
}

// Cargar departamentos
async function cargarDepartamentosList(){
  const snap = await db.collection("departamentos").get();
  let html="";
  snap.forEach(d=>{
    const dept = d.data();
    html+=`<p>${dept.nombre} <button onclick="eliminarDepartamento('${d.id}')">Eliminar</button></p>`;
  });
  document.getElementById("departamentos-lista").innerHTML=html;
}

// Eliminar departamento
async function eliminarDepartamento(id){
  await db.collection("departamentos").doc(id).delete();
  cargarDepartamentosList();
  cargarDepartamentosSelect();
}

// Selects
async function cargarGerenciasSelect(){
  const sel = document.getElementById("gerencia");
  sel.innerHTML="";
  const snap = await db.collection("gerencias").get();
  snap.forEach(d=> sel.innerHTML+=`<option>${d.data().nombre}</option>`);
  document.getElementById("nuevoGerencia").innerHTML = sel.innerHTML;
}

async function cargarDepartamentosSelect(){
  const sel = document.getElementById("departamento");
  sel.innerHTML="";
  const snap = await db.collection("departamentos").get();
  snap.forEach(d=> sel.innerHTML+=`<option>${d.data().nombre}</option>`);
}

// EmailJS
function enviarCorreo(destino,id,estado,mensaje){
  emailjs.send("service_a7yozqh","template_2sy0hqh",{
    to_email: destino,
    id_solicitud: id,
    estado: estado,
    mensaje: mensaje
  }).catch(err=>console.log("Error email:",err));
}
</script>
</body>
</html>
