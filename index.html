<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema Gesti√≥n Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;margin:0}
header{background:#111827;color:#fff;padding:15px}
.card{background:#fff;padding:15px;margin:15px;border-radius:8px}
input,select,textarea,button{width:100%;margin-top:8px;padding:8px;border-radius:4px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ccc;padding:6px;text-align:left}
.hidden{display:none}
h3{margin-top:0}
</style>
</head>
<body>

<header>
<h2>üìÑ FCI ‚Äì Sistema de Gesti√≥n Documental</h2>
</header>

<!-- LOGIN -->
<section id="login-section" class="card">
  <h3>üîê Iniciar Sesi√≥n</h3>
  <input id="inputUsuario" placeholder="Usuario">
  <input id="inputPassword" type="password" placeholder="Contrase√±a">
  <button onclick="login()">Ingresar</button>
</section>

<!-- PANEL PRINCIPAL -->
<section id="panel" class="card hidden">
<h3>Usuario: <span id="usuarioActual"></span> | Rol: <span id="rolActual"></span></h3>

<!-- PANEL ADMIN: Usuarios, Gerencias, Departamentos -->
<div id="admin-panel" class="card hidden">
  <h3>üõ† Panel de Administraci√≥n</h3>

  <div>
    <h4>Usuarios</h4>
    <input id="nuevoUsuario" placeholder="Usuario">
    <input id="nuevoCorreo" placeholder="Correo">
    <input id="nuevoPassword" type="password" placeholder="Contrase√±a">
    <select id="nuevoRol">
      <option>usuario</option>
      <option>gerente</option>
      <option>admin</option>
    </select>
    <select id="nuevoGerencia">
      <option>Gerencia Demo</option>
    </select>
    <button onclick="crearUsuario()">Agregar Usuario</button>
    <table id="tablaUsuarios"><thead><tr><th>Usuario</th><th>Correo</th><th>Rol</th><th>Gerencia</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
  </div>

  <div>
    <h4>Gerencias</h4>
    <input id="nuevaGerenciaInput" placeholder="Nueva Gerencia">
    <button onclick="crearGerencia()">Agregar</button>
    <table id="tablaGerencias"><thead><tr><th>Gerencia</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
  </div>

  <div>
    <h4>Departamentos</h4>
    <input id="nuevoDepartamentoInput" placeholder="Nuevo Departamento">
    <button onclick="crearDepartamento()">Agregar</button>
    <table id="tablaDepartamentos"><thead><tr><th>Departamento</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<!-- NUEVA SOLICITUD -->
<div class="card">
  <h3>‚ûï Nueva Solicitud</h3>
  <select id="tipoAccion">
    <option>Creaci√≥n</option>
    <option>Modificaci√≥n</option>
    <option>Inactivaci√≥n</option>
  </select>
  <input id="nombreDocumento" placeholder="Nombre documento">
  <select id="gerencia"></select>
  <select id="departamento"></select>
  <textarea id="motivo" placeholder="Motivo"></textarea>
  <input id="codificacion" placeholder="Codificaci√≥n actual">
  <input id="ultimaVersion" placeholder="√öltima versi√≥n">
  <input type="date" id="fechaUltimaVersion">
  <input type="file" id="archivo">
  <button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>

<!-- LISTADO SOLICITUDES -->
<div class="card">
  <h3>üìã Solicitudes</h3>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Documento</th>
        <th>Estado</th>
        <th>Solicitante</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody id="tabla"></tbody>
  </table>
</div>

<!-- DETALLES DE SOLICITUD -->
<div class="card hidden" id="detalleSolicitudCard">
  <h3>üìù Detalles de Solicitud</h3>
  <div id="detalleContenido"></div>
  <div id="accionesEstado" class="hidden">
    <h4>Actualizar Estado</h4>
    <select id="nuevoEstado">
      <option value="pendiente">Pendiente</option>
      <option value="consulta">Consulta</option>
      <option value="solicitar_reunion">Solicitar Reuni√≥n</option>
      <option value="aprobado_sistema">Aprobado Sistema</option>
      <option value="solicitar_aprobacion_gerente">Solicitar Aprobaci√≥n Gerente</option>
      <option value="finalizado">Finalizado</option>
    </select>
    <textarea id="motivoEstado" placeholder="Motivo / Observaci√≥n"></textarea>
    <input type="file" id="archivoEstado">
    <button onclick="cambiarEstado()">Actualizar Estado</button>
  </div>
  <button onclick="cerrarDetalle()">Cerrar</button>
</div>

</section>

<script>
// ================= CONFIG FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ================= EMAILJS =================
emailjs.init("2jVnfkJKKG0bpKN-U");

// ================= VARIABLES =================
let usuarios = [{usuario:"Admin", correo:"admin@fcipty.com", password:"123456", rol:"admin", gerencia:"Todas"}];
let usuarioActual = null;
let gerencias = [];
let departamentos = [];
let solicitudActualId = "";

// ================= LOGIN =================
function login(){
  const u = document.getElementById("inputUsuario").value;
  const p = document.getElementById("inputPassword").value;
  const user = usuarios.find(x=>x.usuario===u && x.password===p);
  if(user){
    usuarioActual=user;
    document.getElementById("login-section").classList.add("hidden");
    document.getElementById("panel").classList.remove("hidden");
    document.getElementById("usuarioActual").innerText = user.usuario;
    document.getElementById("rolActual").innerText = user.rol;
    if(user.rol==="admin") document.getElementById("admin-panel").classList.remove("hidden");
    cargarGerencias(); cargarDepartamentos(); cargarUsuarios(); cargarSolicitudes();
  }else alert("Usuario o contrase√±a incorrectos");
}

// ================= FUNCIONES ADMIN =================
async function crearUsuario(){
  const u=document.getElementById("nuevoUsuario").value;
  const c=document.getElementById("nuevoCorreo").value;
  const p=document.getElementById("nuevoPassword").value;
  const r=document.getElementById("nuevoRol").value;
  const g=document.getElementById("nuevoGerencia").value;
  usuarios.push({usuario:u, correo:c, password:p, rol:r, gerencia:g});
  cargarUsuarios();
}
function cargarUsuarios(){
  const tbody=document.querySelector("#tablaUsuarios tbody");
  tbody.innerHTML="";
  usuarios.forEach((u,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${u.usuario}</td><td>${u.correo}</td><td>${u.rol}</td><td>${u.gerencia}</td>
      <td><button onclick="usuarios.splice(${i},1);cargarUsuarios()">Eliminar</button></td>
    </tr>`;
  });
}
async function crearGerencia(){
  const g=document.getElementById("nuevaGerenciaInput").value;
  await db.collection("gerencias").add({nombre:g});
  cargarGerencias();
}
async function crearDepartamento(){
  const d=document.getElementById("nuevoDepartamentoInput").value;
  await db.collection("departamentos").add({nombre:d});
  cargarDepartamentos();
}

// ================= FUNCIONES SOLICITUD =================
async function generarID(){
  const ref=db.collection("counters").doc("global");
  return db.runTransaction(async t=>{
    const d=await t.get(ref);
    let n=(d.exists?d.data().solicitudes:0)+1;
    t.set(ref,{solicitudes:n},{merge:true});
    return "FCI-SOL-"+String(n).padStart(4,"0");
  });
}
async function subirArchivo(file){
  if(!file) return "";
  const form=new FormData();
  form.append("file",file);
  form.append("upload_preset","fci_documentos");
  const res=await fetch("https://api.cloudinary.com/v1_1/df79cjklp/auto/upload",{method:"POST",body:form});
  const data=await res.json();
  return data.secure_url;
}
async function crearSolicitud(){
  const id=await generarID();
  const file=document.getElementById("archivo").files[0];
  const url=await subirArchivo(file);
  const s={
    idSolicitud:id,
    tipoAccion:document.getElementById("tipoAccion").value,
    nombreDocumento:document.getElementById("nombreDocumento").value,
    gerencia:document.getElementById("gerencia").value,
    departamento:document.getElementById("departamento").value,
    motivo:document.getElementById("motivo").value,
    codificacionActual:document.getElementById("codificacion").value,
    ultimaVersion:document.getElementById("ultimaVersion").value,
    fechaUltimaVersion:document.getElementById("fechaUltimaVersion").value,
    documento:url||"",
    estado:"pendiente",
    solicitante:{usuario:usuarioActual.usuario,correo:usuarioActual.correo},
    fecha:firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection("solicitudes").add(s);
  enviarCorreo(usuarioActual.correo,id,"pendiente","Tu solicitud fue registrada correctamente.");
  cargarSolicitudes();
}

// ================= CARGAR DATOS =================
async function cargarGerencias(){
  const sel=document.getElementById("gerencia");
  sel.innerHTML="";
  const snap=await db.collection("gerencias").get();
  snap.forEach(d=>{
    const g=d.data().nombre;
    sel.innerHTML+=`<option>${g}</option>`;
    if(!gerencias.includes(g)) gerencias.push(g);
    const selNew=document.getElementById("nuevoGerencia");
    if(selNew) selNew.innerHTML+=`<option>${g}</option>`;
  });
}
async function cargarDepartamentos(){
  const sel=document.getElementById("departamento");
  sel.innerHTML="";
  const snap=await db.collection("departamentos").get();
  snap.forEach(d=>{
    const dep=d.data().nombre;
    sel.innerHTML+=`<option>${dep}</option>`;
    if(!departamentos.includes(dep)) departamentos.push(dep);
  });
}

// ================= CARGAR SOLICITUDES =================
async function cargarSolicitudes(){
  const tabla=document.getElementById("tabla");
  tabla.innerHTML="";
  const snap=await db.collection("solicitudes").orderBy("fecha","desc").get();
  snap.forEach(d=>{
    const s=d.data();
    tabla.innerHTML+=`<tr>
      <td>${s.idSolicitud}</td>
      <td>${s.nombreDocumento}</td>
      <td>${s.estado}</td>
      <td>${s.solicitante.usuario}</td>
      <td><button onclick="verSolicitud('${d.id}')">Ver Detalles</button></td>
    </tr>`;
  });
}

// ================= DETALLES =================
async function verSolicitud(docId){
  solicitudActualId=docId;
  const doc=await db.collection("solicitudes").doc(docId).get();
  const s=doc.data();
  let html=`<p><b>ID:</b> ${s.idSolicitud}</p>
  <p><b>Documento:</b> ${s.nombreDocumento}</p>
  <p><b>Estado:</b> ${s.estado}</p>
  <p><b>Solicitante:</b> ${s.solicitante.usuario} (${s.solicitante.correo})</p>
  <p><b>Tipo acci√≥n:</b> ${s.tipoAccion}</p>
  <p><b>Gerencia:</b> ${s.gerencia}</p>
  <p><b>Departamento:</b> ${s.departamento}</p>
  <p><b>Motivo:</b> ${s.motivo}</p>
  <p><b>Codificaci√≥n:</b> ${s.codificacionActual}</p>
  <p><b>√öltima versi√≥n:</b> ${s.ultimaVersion}</p>
  <p><b>Fecha √∫ltima versi√≥n:</b> ${s.fechaUltimaVersion}</p>
  <p><b>Documento adjunto:</b> <a href="${s.documento}" target="_blank">Ver archivo</a></p>`;
  
  document.getElementById("detalleContenido").innerHTML=html;
  if(usuarioActual.rol==="admin" || (usuarioActual.rol==="gerente" && s.gerencia===usuarioActual.gerencia)){
    document.getElementById("accionesEstado").classList.remove("hidden");
  }else{
    document.getElementById("accionesEstado").classList.add("hidden");
  }
  document.getElementById("detalleSolicitudCard").classList.remove("hidden");
}

function cerrarDetalle(){document.getElementById("detalleSolicitudCard").classList.add("hidden");}

// ================= CAMBIAR ESTADO =================
async function cambiarEstado(){
  const estado=document.getElementById("nuevoEstado").value;
  const motivo=document.getElementById("motivoEstado").value;
  const file=document.getElementById("archivoEstado").files[0];
  const url=await subirArchivo(file);

  await db.collection("solicitudes").doc(solicitudActualId).update({
    estado:estado,
    motivoEstado:motivo,
    documentoEstado:url||firebase.firestore.FieldValue.delete()
  });
  alert("Estado actualizado");
  cargarSolicitudes();
  cerrarDetalle();
}

// ================= EMAIL =================
function enviarCorreo(destino,id,estado,mensaje){
  emailjs.send("service_a7yozqh","template_2sy0hqh",{
    to_email: destino,
    id_solicitud: id,
    estado: estado,
    mensaje: mensaje
  }).catch(err=>console.log("Error email:",err));
}
</script>
</body>
</html>
