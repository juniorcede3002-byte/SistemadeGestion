<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FCI | GestiÃ³n Documental 2</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;margin:0}
header{background:#111827;color:#fff;padding:15px}
.card{background:#fff;padding:15px;margin:15px;border-radius:8px}
input,select,textarea,button{width:100%;margin-top:8px;padding:8px;border-radius:4px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ccc;padding:6px;text-align:left}
.hidden{display:none}
</style>
</head>

<body>

<header>
<h2>ðŸ“„ FCI â€“ Sistema de Solicitudes Documentales</h2>
</header>

<!-- LOGIN -->
<section id="login" class="card">
<h3>Iniciar sesiÃ³n</h3>
<input id="email" placeholder="Correo" value="admin@fcipty.com">
<input id="password" type="password" placeholder="ContraseÃ±a" value="Admin123!">
<button id="btnLogin">Ingresar</button>
</section>

<!-- PANEL PRINCIPAL -->
<section id="panel" class="hidden">

<div class="card">
<h3>âž• Nueva Solicitud</h3>

<select id="tipoAccion">
<option>CreaciÃ³n</option>
<option>ModificaciÃ³n</option>
<option>InactivaciÃ³n</option>
</select>

<input id="nombreDocumento" placeholder="Nombre documento">
<input id="gerencia" placeholder="Gerencia">
<input id="departamento" placeholder="Departamento">
<textarea id="motivo" placeholder="Motivo"></textarea>

<input id="codificacion" placeholder="CodificaciÃ³n actual">
<input id="ultimaVersion" placeholder="Ãšltima versiÃ³n">
<input type="date" id="fechaUltimaVersion">

<input type="file" id="archivo">
<button onclick="crearSolicitud()">Enviar Solicitud</button>
</div>

<div class="card">
<h3>ðŸ“‹ Solicitudes</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>Documento</th>
<th>Estado</th>
<th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

</section>

<script>
// ================= CONFIG FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.firebasestorage.app",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
});

// Inicializar EmailJS
emailjs.init("TU_PUBLIC_KEY_EMAILJS"); // Reemplaza con tu Public Key

const auth = firebase.auth();
const db = firebase.firestore();
let usuario = {};

// ================= LOGIN FUNCIONANDO =================
document.getElementById("btnLogin").addEventListener("click", login);

async function login(){
  const correo = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  if(!correo || !password){ alert("Ingresa correo y contraseÃ±a"); return; }

  try{
    const cred = await auth.signInWithEmailAndPassword(correo,password);

    // Verificar si existe documento en Firestore
    const snap = await db.collection("users").doc(cred.user.uid).get();

    if(!snap.exists){
      // Crear documento automÃ¡ticamente si no existe
      await db.collection("users").doc(cred.user.uid).set({
        correo: correo,
        rol: "admin",        // Por defecto admin si no existe
        gerencia: "",
        activo: true
      });
      usuario = {
        correo: correo,
        rol: "admin",
        gerencia: "",
        activo: true,
        uid: cred.user.uid
      };
    } else {
      usuario = snap.data();
      usuario.uid = cred.user.uid;
    }

    // Mostrar panel
    login.classList.add("hidden");
    panel.classList.remove("hidden");

    cargarSolicitudes();

  } catch(err){
    alert("Error de login: "+err.message);
  }
}

// Detectar sesiÃ³n activa
auth.onAuthStateChanged(async u=>{
  if(u && !usuario.uid){
    const snap = await db.collection("users").doc(u.uid).get();
    if(snap.exists){
      usuario = snap.data();
      usuario.uid = u.uid;
      login.classList.add("hidden");
      panel.classList.remove("hidden");
      cargarSolicitudes();
    } else {
      // Crear admin automÃ¡ticamente
      await db.collection("users").doc(u.uid).set({
        correo: u.email,
        rol: "admin",
        gerencia: "",
        activo: true
      });
      usuario = { correo: u.email, rol:"admin", gerencia:"", activo:true, uid:u.uid };
      login.classList.add("hidden");
      panel.classList.remove("hidden");
      cargarSolicitudes();
    }
  }
});

// ================= FUNCIONES SOLICITUD =================

// Generar ID Ãºnico
async function generarID(){
  const ref = db.collection("counters").doc("global");
  return db.runTransaction(async t=>{
    const d = await t.get(ref);
    let n = (d.exists ? d.data().solicitudes : 0) + 1;
    t.set(ref,{solicitudes:n},{merge:true});
    return "FCI-SOL-" + String(n).padStart(4,"0");
  });
}

// Subir archivo a Cloudinary
async function subirArchivo(file){
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", "fci_unsigned"); // tu preset
  const res = await fetch("https://api.cloudinary.com/v1_1/df79cjklp/auto/upload",
    {method:"POST", body:form});
  const data = await res.json();
  return data.secure_url;
}

// Crear solicitud
async function crearSolicitud(){
  const id = await generarID();
  let url = "";
  const archivoFile = document.getElementById("archivo").files[0];
  if(archivoFile){ url = await subirArchivo(archivoFile); }

  const nuevaSolicitud = {
    idSolicitud:id,
    tipoAccion:document.getElementById("tipoAccion").value,
    nombreDocumento:document.getElementById("nombreDocumento").value,
    gerencia:document.getElementById("gerencia").value,
    departamento:document.getElementById("departamento").value,
    motivo:document.getElementById("motivo").value,
    codificacionActual:document.getElementById("codificacion").value,
    ultimaVersion:document.getElementById("ultimaVersion").value,
    fechaUltimaVersion:document.getElementById("fechaUltimaVersion").value,
    documento:url,
    estado:"pendiente",
    solicitante:{ uid:usuario.uid, correo:usuario.correo },
    fecha:firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("solicitudes").add(nuevaSolicitud);

  // Autoreply al usuario
  enviarCorreo(usuario.correo,id,"Pendiente","Tu solicitud fue registrada correctamente.");

  // NotificaciÃ³n al gerente
  if(document.getElementById("gerencia").value){
    enviarCorreo("gerente@empresa.com",id,"Pendiente de aprobaciÃ³n","Tienes una solicitud pendiente de revisiÃ³n.");
  }

  alert("Solicitud creada: "+id);
  cargarSolicitudes();
}

// Cargar solicitudes segÃºn rol
async function cargarSolicitudes(){
  const tabla = document.getElementById("tabla");
  tabla.innerHTML="";
  let q;

  if(usuario.rol==="usuario"){
    q = db.collection("solicitudes").where("solicitante.uid","==",usuario.uid);
  } else if(usuario.rol==="gerente"){
    q = db.collection("solicitudes").where("gerencia","==",usuario.gerencia);
  } else { // admin
    q = db.collection("solicitudes");
  }

  const snap = await q.get();
  snap.forEach(d=>{
    const s = d.data();
    let boton = "";
    if(usuario.rol==="gerente" && s.estado!=="finalizado"){
      boton = `<button onclick="finalizar('${d.id}')">Finalizar</button>`;
    }
    tabla.innerHTML+=`
    <tr>
      <td>${s.idSolicitud}</td>
      <td>${s.nombreDocumento}</td>
      <td>${s.estado}</td>
      <td>${boton}</td>
    </tr>`;
  });
}

// Finalizar solicitud (solo gerente)
async function finalizar(id){
  const docRef = db.collection("solicitudes").doc(id);
  await docRef.update({
    estado:"finalizado",
    "gerente.aprobado":true,
    "gerente.nombre":usuario.correo
  });
  const doc = await docRef.get();
  enviarCorreo(doc.data().solicitante.correo,doc.data().idSolicitud,"Finalizado","La solicitud fue aprobada y cerrada.");
  cargarSolicitudes();
}

// FunciÃ³n EmailJS
function enviarCorreo(destino,id,estado,mensaje){
  emailjs.send("TU_SERVICE_ID","TU_TEMPLATE_ID",{
    to_email: destino,
    id_solicitud: id,
    estado: estado,
    mensaje: mensaje
  }).catch(err=>console.log("Error email:",err));
}
</script>

</body>
</html>
