<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Gestión Documental</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
header{background:#1e293b;color:white;padding:15px}
section{padding:15px}
.card{background:white;padding:15px;border-radius:8px;margin-bottom:15px}
input,select,textarea,button{width:100%;padding:8px;margin:5px 0}
button{background:#2563eb;color:white;border:none;border-radius:5px;cursor:pointer}
button.delete{background:#dc2626}
.list{border-top:1px solid #ddd;margin-top:10px}
.item{padding:8px;border-bottom:1px solid #ddd}
.flex{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px}
small{color:#555}
</style>
</head>

<body>

<header>
<h2>Sistema de Gestión Documental</h2>
</header>

<section class="flex">

<!-- USUARIOS -->
<div class="card">
<h3>Crear Usuario</h3>
<input id="u_nombre" placeholder="Nombre completo">
<input id="u_correo" placeholder="Correo">
<button onclick="crearUsuario()">Crear</button>
<div id="listaUsuarios" class="list"></div>
</div>

<!-- DEPARTAMENTOS -->
<div class="card">
<h3>Departamentos</h3>
<input id="d_nombre" placeholder="Nombre">
<button onclick="crearDepartamento()">Crear</button>
<div id="listaDepartamentos" class="list"></div>
</div>

<!-- GERENCIAS -->
<div class="card">
<h3>Gerencias</h3>
<input id="g_nombre" placeholder="Nombre">
<button onclick="crearGerencia()">Crear</button>
<div id="listaGerencias" class="list"></div>
</div>

<!-- SOLICITUDES -->
<div class="card">
<h3>Nueva Solicitud</h3>
<select id="s_usuario"></select>
<select id="s_departamento"></select>
<select id="s_gerencia"></select>
<textarea id="s_motivo" placeholder="Motivo"></textarea>
<input type="file" id="s_archivo">
<button onclick="crearSolicitud()">Enviar</button>
</div>

</section>

<section class="card">
<h3>Historial de Solicitudes</h3>
<div id="listaSolicitudes"></div>
</section>

<section class="card">
<h3>Dashboard</h3>
<canvas id="grafica"></canvas>
</section>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
 apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
 authDomain: "sistemadegestion-7400d.firebaseapp.com",
 projectId: "sistemadegestion-7400d",
 storageBucket: "sistemadegestion-7400d.firebasestorage.app",
 messagingSenderId: "709030283072",
 appId: "1:709030283072:web:5997837b36a448e9515ca5"
});
const db = firebase.firestore();

/* ============== CLOUDINARY ============== */
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/df79cjklp/auto/upload";
const CLOUDINARY_PRESET = "fci_documentos";

/* ============== USUARIOS ============== */
function crearUsuario(){
 db.collection("Usuarios").add({
  nombre:u_nombre.value,
  correo:u_correo.value,
  fecha:new Date()
 });
}

function cargarUsuarios(){
 listaUsuarios.innerHTML="";
 s_usuario.innerHTML="";
 db.collection("Usuarios").onSnapshot(s=>{
  s.forEach(d=>{
   let u=d.data();
   listaUsuarios.innerHTML+=`
    <div class="item">
     <b>${u.nombre}</b><br><small>${u.correo}</small>
     <button class="delete" onclick="eliminar('Usuarios','${d.id}')">Eliminar</button>
    </div>`;
   s_usuario.innerHTML+=`<option value="${d.id}">${u.nombre}</option>`;
  });
 });
}

/* ============== DEPARTAMENTOS ============== */
function crearDepartamento(){
 db.collection("Departamentos").add({nombre:d_nombre.value});
}
function cargarDepartamentos(){
 listaDepartamentos.innerHTML="";
 s_departamento.innerHTML="";
 db.collection("Departamentos").onSnapshot(s=>{
  s.forEach(d=>{
   listaDepartamentos.innerHTML+=`
    <div class="item">${d.data().nombre}
    <button class="delete" onclick="eliminar('Departamentos','${d.id}')">Eliminar</button></div>`;
   s_departamento.innerHTML+=`<option value="${d.id}">${d.data().nombre}</option>`;
  });
 });
}

/* ============== GERENCIAS ============== */
function crearGerencia(){
 db.collection("Gerencias").add({nombre:g_nombre.value});
}
function cargarGerencias(){
 listaGerencias.innerHTML="";
 s_gerencia.innerHTML="";
 db.collection("Gerencias").onSnapshot(s=>{
  s.forEach(d=>{
   listaGerencias.innerHTML+=`
    <div class="item">${d.data().nombre}
    <button class="delete" onclick="eliminar('Gerencias','${d.id}')">Eliminar</button></div>`;
   s_gerencia.innerHTML+=`<option value="${d.id}">${d.data().nombre}</option>`;
  });
 });
}

/* ============== SOLICITUDES ============== */
async function crearSolicitud(){
 let file=s_archivo.files[0];
 let url="";
 if(file){
  let fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset",CLOUDINARY_PRESET);
  let r=await fetch(CLOUDINARY_URL,{method:"POST",body:fd});
  let j=await r.json();
  url=j.secure_url;
 }
 db.collection("Solicitudes").add({
  usuario:s_usuario.value,
  departamento:s_departamento.value,
  gerencia:s_gerencia.value,
  motivo:s_motivo.value,
  archivo:url,
  fecha:new Date()
 });
}

/* ============== HISTORIAL + PDF ============== */
function cargarSolicitudes(){
 listaSolicitudes.innerHTML="";
 db.collection("Solicitudes").onSnapshot(s=>{
  let total=0;
  s.forEach(d=>{
   total++;
   let sol=d.data();
   listaSolicitudes.innerHTML+=`
    <div class="item">
     <b>Motivo:</b> ${sol.motivo}<br>
     <small>${sol.fecha.toDate()}</small><br>
     <button onclick="pdfSolicitud('${d.id}')">PDF</button>
     <button class="delete" onclick="eliminar('Solicitudes','${d.id}')">Eliminar</button>
    </div>`;
  });
  grafica(total);
 });
}

function pdfSolicitud(id){
 db.collection("Solicitudes").doc(id).get().then(d=>{
  let s=d.data();
  const {jsPDF}=window.jspdf;
  let pdf=new jsPDF();
  pdf.text("Reporte de Solicitud",20,20);
  pdf.text("Motivo: "+s.motivo,20,40);
  pdf.text("Fecha: "+s.fecha.toDate(),20,60);
  if(s.archivo) pdf.text("Archivo: "+s.archivo,20,80);
  pdf.save("solicitud.pdf");
 });
}

/* ============== GRAFICA ============== */
let chart;
function grafica(total){
 if(chart) chart.destroy();
 chart=new Chart(document.getElementById("grafica"),{
  type:"bar",
  data:{labels:["Solicitudes"],datasets:[{data:[total]}]}
 });
}

/* ============== UTIL ============== */
function eliminar(col,id){
 if(confirm("¿Eliminar?")) db.collection(col).doc(id).delete();
}

/* ============== INIT ============== */
cargarUsuarios();
cargarDepartamentos();
cargarGerencias();
cargarSolicitudes();
</script>

</body>
</html>