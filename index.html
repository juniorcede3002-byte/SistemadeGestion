<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Gestión de Documentos - FCI</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f4f4f4;color:#333}
.container{width:95%;max-width:1200px;margin:auto;padding:15px;background:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
h1, h2{color:#0056b3}
section{margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid #ddd}
.table-container { width: 100%; overflow-x: auto; margin-top: 10px; border: 1px solid #ccc; }
table{width:100%; border-collapse:collapse; min-width: 700px;}
th,td{border:1px solid #eee;padding:10px;text-align:left; font-size: 13px;}
th{background:#0056b3; color: white;}
input,select,textarea{padding:8px;margin:5px 0;width:100%;box-sizing:border-box;border:1px solid #ccc;border-radius:4px}
button{padding:10px 15px;cursor:pointer; background:#007bff; color:white; border:none; border-radius:4px; font-weight:bold}
.btn-delete{background:#dc3545}
.dashboard{display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;}
.card{flex: 1; min-width: 140px; padding: 15px; background: #ebf5ff; border-radius: 8px; text-align: center; border: 1px solid #b3d7ff;}
.card p{margin: 5px 0 0; font-size: 1.5em; font-weight: bold; color: #0056b3;}
.id-badge { background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
.permiso-tag { background: #e2e2e2; padding: 2px 5px; border-radius: 3px; margin-right: 2px; font-size: 11px; }
</style>
</head>
<body>

<div class="container">
    <h1>FCI - Gestión de Documentos</h1>

    <section>
        <div class="dashboard">
            <div class="card"><h3>Total Solicitudes</h3><p id="stat-total">0</p></div>
            <div class="card"><h3>Pendientes</h3><p id="stat-Pendiente">0</p></div>
            <div class="card"><h3>En Proceso</h3><p id="stat-Revision">0</p></div>
            <div class="card"><h3>Finalizados</h3><p id="stat-Finalizado">0</p></div>
        </div>
    </section>

    <section>
        <h2>Gestión de Usuarios (Colección: Users)</h2>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <input type="text" id="usuarioNombre" placeholder="Nombre Completo">
            <input type="email" id="usuarioCorreo" placeholder="Correo electrónico">
            <input type="password" id="usuarioPassword" placeholder="Contraseña">
            <select id="usuarioGerencia"></select>
            <select id="usuarioDepartamento"></select>
            <div style="margin: 10px 0;">
                <strong>Permisos:</strong><br>
                <label><input type="checkbox" id="p_solicitudes"> Crear Solicitudes</label>
                <label><input type="checkbox" id="p_aprobar"> Aprobar</label>
                <label><input type="checkbox" id="p_gestionar"> Gestionar Usuarios</label>
            </div>
            <button onclick="crearUsuario()">Registrar Nuevo Usuario</button>
        </div>

        <div class="table-container">
            <table id="tablaUsuarios">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Rol</th>
                        <th>Permisos Habilitados</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section>
        <h2>Nueva Solicitud de Documento</h2>
        <input type="text" id="solTitulo" placeholder="Título del Documento">
        <select id="solTipo">
            <option>Procedimiento</option><option>Guía</option><option>Instructivo</option><option>Manual</option><option>Formato</option>
        </select>
        <select id="solAccion">
            <option>Creación</option><option>Modificación</option><option>Inactivación</option>
        </select>
        <select id="solGerencia"></select>
        <select id="solDepartamento"></select>
        <input type="text" id="solMotivo" placeholder="Motivo">
        <textarea id="solDescripcion" placeholder="Descripción detallada..."></textarea>
        <input type="file" id="solArchivos" multiple>
        <button onclick="crearSolicitud()" style="background:#28a745">Enviar Solicitud</button>
    </section>

    <section>
        <h2>Listado de Solicitudes</h2>
        <div class="table-container">
            <table id="tablaSolicitudes">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDdzCiachuhbE9jATz-TesPI2vUVIJrHjM",
  authDomain: "sistemadegestion-7400d.firebaseapp.com",
  projectId: "sistemadegestion-7400d",
  storageBucket: "sistemadegestion-7400d.appspot.com",
  messagingSenderId: "709030283072",
  appId: "1:709030283072:web:5997837b36a448e9515ca5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const cloudName = "df79cjklp"; 
const uploadPreset = "fci_documentos"; 
const ESTADOS = ["Pendiente","Solicitud de Reunión","Realizar Consultas","Solicitud 3 Firmas","Solicitud Aprobación Gerente","Finalizado"];

// --- LÓGICA DE USUARIOS (Colección 'Users') ---
async function crearUsuario(){
    let nombre = document.getElementById("usuarioNombre").value;
    let correo = document.getElementById("usuarioCorreo").value;
    let pass = document.getElementById("usuarioPassword").value;
    
    if(!nombre || !correo) return alert("Complete los datos");
    
    await db.collection("Users").add({
        nombre: nombre,
        correo: correo,
        pass: pass,
        rol: "Usuario",
        permisos: {
            solicitudes: document.getElementById("p_solicitudes").checked,
            aprobar: document.getElementById("p_aprobar").checked,
            gestionar: document.getElementById("p_gestionar").checked,
            verGerencia: false,
            verPropias: true
        }
    });
    alert("Usuario guardado en carpeta Users");
}

function cargarUsuariosRealTime() {
    // Apuntamos a "Users" con U mayúscula como en tu captura
    db.collection("Users").onSnapshot(snap => {
        let tbody = document.querySelector("#tablaUsuarios tbody");
        tbody.innerHTML = "";
        snap.forEach(doc => {
            let u = doc.data();
            let p = u.permisos || {};
            
            // Convertimos el mapa de permisos a etiquetas legibles
            let listaPermisos = "";
            if(p.solicitudes) listaPermisos += '<span class="permiso-tag">Crear</span>';
            if(p.aprobar) listaPermisos += '<span class="permiso-tag">Aprobar</span>';
            if(p.gestionar) listaPermisos += '<span class="permiso-tag">Admin</span>';

            tbody.innerHTML += `<tr>
                <td>${u.nombre || doc.id}</td>
                <td>${u.correo || 'S/E'}</td>
                <td>${u.rol || 'N/A'}</td>
                <td>${listaPermisos || 'Ninguno'}</td>
                <td><button class="btn-delete" onclick="eliminar('Users','${doc.id}')">Eliminar</button></td>
            </tr>`;
        });
    });
}

// --- LÓGICA DE SOLICITUDES ---
async function obtenerSiguienteID() {
    const docRef = db.collection("configuracion").doc("contadores");
    return db.runTransaction(async (transaction) => {
        const doc = await transaction.get(docRef);
        let nuevoNumero = doc.exists ? doc.data().solicitudActual + 1 : 1;
        transaction.set(docRef, { solicitudActual: nuevoNumero });
        return "FCI-SGD-" + nuevoNumero.toString().padStart(4, '0');
    });
}

async function crearSolicitud(){
    let titulo = document.getElementById("solTitulo").value;
    if(!titulo) return alert("Título obligatorio");
    const fciId = await obtenerSiguienteID();
    
    await db.collection("solicitudes").add({
        fciId, titulo, 
        tipo: document.getElementById("solTipo").value,
        estado: "Pendiente", 
        fecha: new Date()
    });
    alert("Solicitud registrada: " + fciId);
}

function cargarSolicitudesRealTime() {
    db.collection("solicitudes").orderBy("fecha", "desc").onSnapshot(snap => {
        let h="", lista=[];
        snap.forEach(doc => {
            let s = doc.data(); lista.push(s);
            h+=`<tr>
                <td><span class="id-badge">${s.fciId}</span></td>
                <td>${s.titulo}</td><td>${s.tipo}</td><td><strong>${s.estado}</strong></td>
                <td>
                    <select onchange="cambiarEstado('${doc.id}', this.value)">
                        ${ESTADOS.map(e=>`<option ${s.estado==e?"selected":""}>${e}</option>`).join("")}
                    </select>
                </td>
            </tr>`;
        });
        document.querySelector("#tablaSolicitudes tbody").innerHTML=h;
        actualizarDashboard(lista);
    });
}

// --- AUXILIARES ---
function eliminar(col, id){ if(confirm("¿Seguro?")) db.collection(col).doc(id).delete(); }

function cambiarEstado(id, nuevo){ db.collection("solicitudes").doc(id).update({estado: nuevo}); }

function actualizarDashboard(solicitudes) {
    let stats = { total: solicitudes.length, Pendiente: 0, Revision: 0, Finalizado: 0 };
    solicitudes.forEach(s => {
        if(s.estado === "Pendiente") stats.Pendiente++;
        else if(s.estado === "Finalizado") stats.Finalizado++;
        else stats.Revision++;
    });
    document.getElementById("stat-total").innerText = stats.total;
    document.getElementById("stat-Pendiente").innerText = stats.Pendiente;
    document.getElementById("stat-Revision").innerText = stats.Revision;
    document.getElementById("stat-Finalizado").innerText = stats.Finalizado;
}

// Iniciar procesos
cargarUsuariosRealTime();
cargarSolicitudesRealTime();
</script>
</body>
</html>
